{"remainingRequest":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\babel-loader\\lib\\index.js!D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\group-live\\components\\live-pusher.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\group-live\\components\\live-pusher.vue","mtime":1649851412189},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\babel-loader\\lib\\index.js","mtime":1649851455045},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js","mtime":1649851455309},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\babel.config.js","mtime":1649851550121},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\babel-loader\\lib\\index.js","mtime":1649851455045},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js","mtime":1649851455309}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"D:/project/softwareDevelopment/IM-Web/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _defineProperty from \"D:/project/softwareDevelopment/IM-Web/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport axios from 'axios';\nimport { mapState } from 'vuex';\nimport liveHeader from \"./live-header\"; // import liveShare from './live-share'\n\nimport { formatTime } from \"../../../utils/date.js\";\nexport default {\n  name: 'livePusher',\n  data: function data() {\n    return {\n      pusher: null,\n      roomID: 0,\n      roomName: '',\n      isPushingStream: false,\n      // 是否正在推流\n      updateTimer: 0,\n      pusherTime: '00:00:00',\n      time: 0,\n      // 直播时长 秒\n      recordTimer: null,\n      // 记录直播时长\n      isMute: false,\n      //是否禁言\n      isStartCamera: true\n    };\n  },\n  computed: _objectSpread(_objectSpread({}, mapState({\n    user: function user(state) {\n      return state.user;\n    },\n    groupLiveInfo: function groupLiveInfo(state) {\n      return state.groupLive.groupLiveInfo;\n    }\n  })), {}, {\n    anchorAvatar: function anchorAvatar() {\n      return this.user.currentUserProfile.avatar || 'https://imgcache.qq.com/open/qcloud/video/act/webim-avatar/avatar-2.png';\n    }\n  }),\n  created: function created() {\n    this.$store.commit('resetGroupLiveInfo', {\n      roomID: 0\n    });\n  },\n  mounted: function mounted() {\n    this.init();\n  },\n  beforeDestroy: function () {\n    var _beforeDestroy = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n      return regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!this.isPushingStream) {\n                _context.next = 5;\n                break;\n              }\n\n              clearInterval(this.updateTimer);\n              clearInterval(this.recordTimer);\n              _context.next = 5;\n              return this.stopPush();\n\n            case 5:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function beforeDestroy() {\n      return _beforeDestroy.apply(this, arguments);\n    }\n\n    return beforeDestroy;\n  }(),\n  components: {\n    liveHeader: liveHeader // liveShare,\n\n  },\n  methods: {\n    // 初始化\n    init: function init() {\n      this.pusher = this.TWebLive.createPusher({\n        userID: this.user.userID\n      });\n      this.setRenderView();\n      this.pusher.on(this.TWebLive.EVENT.RTC_CONNECTION_STATE_CHANGED, this.onRTCConnectionStateChanged);\n      this.pusher.on(this.TWebLive.EVENT.RTC_CLIENT_BANNED, this.onRTCClientBanned);\n      this.pusher.on(this.TWebLive.EVENT.RTC_CLIENT_ERROR, this.onRTCError);\n    },\n    // eslint-disable-next-line no-unused-vars\n    onRTCConnectionStateChanged: function onRTCConnectionStateChanged(event) {},\n    // eslint-disable-next-line no-unused-vars\n    onRTCClientBanned: function onRTCClientBanned(event) {},\n    // eslint-disable-next-line no-unused-vars\n    onRTCError: function onRTCError(event) {},\n    //开启本地预览\n    setRenderView: function setRenderView() {\n      var _this = this;\n\n      this.pusher.setRenderView({\n        elementID: 'video-container',\n        audio: true,\n        video: true\n      }).then(function () {\n        // 设置背景\n        var el = window.document.getElementById('video-container').childNodes;\n        el[0].style.backgroundColor = 'rgba(0,0,0,0)';\n        _this.isStartCamera = false;\n      }).catch(function () {});\n    },\n    // 摄像头、麦克风操作\n    startCamera: function startCamera() {\n      var _this2 = this;\n\n      this.pusher.startCamera().then(function () {\n        _this2.isStartCamera = false;\n      }).catch(function () {});\n    },\n    stopCamera: function stopCamera() {\n      var _this3 = this;\n\n      this.pusher.stopCamera().then(function () {\n        _this3.isStartCamera = true;\n      }).catch(function () {});\n    },\n    startMicrophone: function startMicrophone() {\n      var _this4 = this;\n\n      this.pusher.startMicrophone().then(function () {\n        _this4.isMute = false;\n      }).catch(function () {});\n    },\n    stopMicrophone: function stopMicrophone() {\n      var _this5 = this;\n\n      this.pusher.stopMicrophone().then(function () {\n        _this5.isMute = true;\n      }).catch(function () {});\n    },\n    // 生成roomID\n    generateRoomID: function generateRoomID(min, max) {\n      return Math.floor(Math.random() * (max - min) + min).toString();\n    },\n    // 创建直播房间\n    createRoom: function () {\n      var _createRoom = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                this.roomID = this.generateRoomID(1000, 2000000000);\n                this.roomName = this.roomName ? this.roomName : \"\".concat(this.user.userID, \"\\u7684\\u76F4\\u64AD\");\n                _context2.next = 4;\n                return axios(\"https://service-62h5r0ea-1252463788.gz.apigw.tencentcs.com/release/forTestAdvanced?method=createRoom&appId=\".concat(this.user.sdkAppID, \"&type=groupLive&title=\").concat(this.roomName, \"&anchorId=\").concat(this.user.userID, \"&roomId=\").concat(this.roomID));\n\n              case 4:\n                this.$store.commit('updateGroupLiveInfo', {\n                  roomID: this.roomID,\n                  roomName: this.roomName\n                });\n                this.createGroupLiveAvChatRoom();\n\n              case 6:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function createRoom() {\n        return _createRoom.apply(this, arguments);\n      }\n\n      return createRoom;\n    }(),\n    // 解散直播间\n    destroyRoom: function () {\n      var _destroyRoom = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3() {\n        return regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return axios(\"https://service-c2zjvuxa-1252463788.gz.apigw.tencentcs.com/release/forTest?method=destroyRoom&appId=\".concat(this.user.sdkAppID, \"&type=groupLive&roomId=\").concat(this.roomID));\n\n              case 2:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function destroyRoom() {\n        return _destroyRoom.apply(this, arguments);\n      }\n\n      return destroyRoom;\n    }(),\n    // 更新直播间 10s 上报一次，心跳保活，如果不上报，后台检测不到心跳会销毁房间\n    updateRoom: function updateRoom() {\n      axios(\"https://service-c2zjvuxa-1252463788.gz.apigw.tencentcs.com/release/forTest?method=updateRoom&appId=\".concat(this.user.sdkAppID, \"&type=groupLive&roomId=\").concat(this.roomID));\n    },\n    // 创建直播互动群\n    createGroupLiveAvChatRoom: function () {\n      var _createGroupLiveAvChatRoom = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee4() {\n        return regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                _context4.next = 2;\n                return this.tim.createGroup({\n                  name: this.roomName,\n                  groupID: this.roomID,\n                  type: this.TIM.TYPES.GRP_AVCHATROOM\n                });\n\n              case 2:\n                this.$bus.$emit('join-group-live-avchatroom');\n\n              case 3:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function createGroupLiveAvChatRoom() {\n        return _createGroupLiveAvChatRoom.apply(this, arguments);\n      }\n\n      return createGroupLiveAvChatRoom;\n    }(),\n    //开始推流\n    startPushStream: function () {\n      var _startPushStream = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee5() {\n        var _this6 = this;\n\n        var streamID, url;\n        return regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                _context5.next = 2;\n                return this.createRoom();\n\n              case 2:\n                //streamID 拼接规则： sdkappid_roomid_userid_main\n                streamID = \"\".concat(this.user.sdkAppID, \"_\").concat(this.roomID, \"_\").concat(this.user.userID, \"_main\"); // 对userSig进行encode,防止userSig中带有+时被浏览器解析为空格，导致trtc ws连接失败\n\n                url = \"room://livedomainname=tuikit.qcloud.com&sdkappid=\".concat(this.user.sdkAppID, \"&roomid=\").concat(this.roomID, \"&userid=\").concat(this.user.userID, \"&usersig=\").concat(encodeURIComponent(this.user.userSig), \"&streamid=\").concat(streamID);\n                this.pusher.startPush(url).then(function () {\n                  _this6.isPushingStream = true;\n\n                  _this6.sendNoticeToGroup(1);\n\n                  _this6.updateTimer = setInterval(function () {\n                    _this6.updateRoom();\n                  }, 10000);\n                  _this6.recordTimer = setInterval(function () {\n                    _this6.recordLiveTime();\n                  }, 1000);\n                }).catch(function () {});\n\n              case 5:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function startPushStream() {\n        return _startPushStream.apply(this, arguments);\n      }\n\n      return startPushStream;\n    }(),\n    // 停止推流\n    stopPushStream: function stopPushStream() {\n      // 派发关闭浮层组件事件\n      this.$bus.$emit('close-group-live');\n    },\n    stopPush: function () {\n      var _stopPush = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee6() {\n        return regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                _context6.next = 2;\n                return this.destroyRoom();\n\n              case 2:\n                _context6.next = 4;\n                return this.pusher.stopPush();\n\n              case 4:\n                _context6.next = 6;\n                return this.tim.dismissGroup(this.roomID);\n\n              case 6:\n                // 解散直播群组\n                this.isPushingStream = false;\n                this.sendNoticeToGroup(0);\n\n              case 8:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6, this);\n      }));\n\n      function stopPush() {\n        return _stopPush.apply(this, arguments);\n      }\n\n      return stopPush;\n    }(),\n    // 给群内发送开始直播、结束直播自定义消息\n    // roomStatus 1 开始直播 0 结束直播\n    sendNoticeToGroup: function sendNoticeToGroup(roomStatus) {\n      if (!this.groupLiveInfo.groupID) {\n        return;\n      }\n\n      var _this$user$currentUse = this.user.currentUserProfile,\n          userID = _this$user$currentUse.userID,\n          nick = _this$user$currentUse.nick,\n          avatar = _this$user$currentUse.avatar;\n      var form = {\n        roomId: this.roomID,\n        roomName: this.roomName,\n        roomCover: avatar,\n        roomStatus: \"\".concat(roomStatus),\n        anchorName: nick,\n        version: 4,\n        roomType: 'liveRoom',\n        anchorId: userID,\n        businessID: 'group_live'\n      };\n      var message = this.tim.createCustomMessage({\n        to: this.groupLiveInfo.groupID,\n        conversationType: this.TIM.TYPES.CONV_GROUP,\n        priority: this.TIM.TYPES.MSG_PRIORITY_NORMAL,\n        payload: {\n          data: JSON.stringify(form),\n          description: '',\n          extension: ''\n        }\n      });\n      this.$store.commit('pushCurrentMessageList', message);\n      this.tim.sendMessage(message).then(function () {}).catch(function () {});\n    },\n    // 记录直播时间\n    recordLiveTime: function recordLiveTime() {\n      this.time++;\n      this.pusherTime = formatTime(this.time);\n    }\n  }\n};",{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8DA;AACA;AACA,uC,CACA;;AACA;AAEA;AACAA,oBADA;AAEAC,MAFA,kBAEA;AACA;AACAC,kBADA;AAEAC,eAFA;AAGAC,kBAHA;AAIAC,4BAJA;AAIA;AACAC,oBALA;AAMAC,4BANA;AAOAC,aAPA;AAOA;AACAC,uBARA;AAQA;AACAC,mBATA;AASA;AACAC;AAVA;AAYA,GAfA;AAgBAC,4CACAC;AACAC;AAAA;AAAA,KADA;AAEAC;AAAA;AAAA;AAFA,IADA;AAKAC,gBALA,0BAKA;AACA;AACA;AAPA,IAhBA;AAyBAC,SAzBA,qBAyBA;AACA;AAAAd;AAAA;AACA,GA3BA;AA4BAe,SA5BA,qBA4BA;AACA;AACA,GA9BA;AA+BAC,eA/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAgCA,oBAhCA;AAAA;AAAA;AAAA;;AAiCAC;AACAA;AAlCA;AAAA,qBAmCA,eAnCA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAsCAC;AACAC,0BADA,CAEA;;AAFA,GAtCA;AA0CAC;AACA;AACAC,QAFA,kBAEA;AACA;AACAC;AADA;AAGA;AACA;AACA;AACA;AACA,KAVA;AAWA;AACAC,+BAZA,uCAYAC,KAZA,EAYA,EAZA;AAaA;AACAC,qBAdA,6BAcAD,KAdA,EAcA,EAdA;AAeA;AACAE,cAhBA,sBAgBAF,KAhBA,EAgBA,EAhBA;AAiBA;AACAG,iBAlBA,2BAkBA;AAAA;;AACA;AACAC,oCADA;AAEAC,mBAFA;AAGAC;AAHA,SAIAC,IAJA,CAIA;AACA;AACA;AACAC;AACA;AACA,OATA,EASAC,KATA,CASA,cATA;AAUA,KA7BA;AA8BA;AACAC,eA/BA,yBA+BA;AAAA;;AACA;AACA;AACA,OAFA,EAEAD,KAFA,CAEA,cAFA;AAGA,KAnCA;AAoCAE,cApCA,wBAoCA;AAAA;;AACA;AACA;AACA,OAFA,EAEAF,KAFA,CAEA,cAFA;AAGA,KAxCA;AAyCAG,mBAzCA,6BAyCA;AAAA;;AACA;AACA;AACA,OAFA,EAEAH,KAFA,CAEA,cAFA;AAGA,KA7CA;AA8CAI,kBA9CA,4BA8CA;AAAA;;AACA;AACA;AACA,OAFA,EAEAJ,KAFA,CAEA,cAFA;AAGA,KAlDA;AAmDA;AACAK,kBApDA,0BAoDAC,GApDA,EAoDAC,GApDA,EAoDA;AACA;AACA,KAtDA;AAuDA;AACAC,cAxDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAyDA;AACA;AA1DA;AAAA,uBA2DAC,sQA3DA;;AAAA;AA4DA;AAAA1C;AAAAC;AAAA;AACA;;AA7DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AA+DA;AACA0C,eAhEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAiEAD,uLAjEA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAmEA;AACAE,cApEA,wBAoEA;AACAF;AACA,KAtEA;AAuEA;AACAG,6BAxEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAyEA;AACAhD,qCADA;AAEAiD,sCAFA;AAGAC;AAHA,kBAzEA;;AAAA;AA8EA;;AA9EA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAgFA;AACAC,mBAjFA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAkFA,iBAlFA;;AAAA;AAmFA;AACAC,wBApFA,aAoFA,kBApFA,cAoFA,WApFA,cAoFA,gBApFA,YAqFA;;AACAC,mBAtFA,8DAsFA,kBAtFA,qBAsFA,WAtFA,qBAsFA,gBAtFA,sBAsFAC,qCAtFA,uBAsFAF,QAtFA;AAuFA;AACA;;AACA;;AACA;AACA;AACA,mBAFA,EAEA,KAFA;AAGA;AACA;AACA,mBAFA,EAEA,IAFA;AAGA,iBATA,EASAhB,KATA,CASA,cATA;;AAvFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAkGA;AACAmB,kBAnGA,4BAmGA;AACA;AACA;AACA,KAtGA;AAuGAC,YAvGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAwGA,kBAxGA;;AAAA;AAAA;AAAA,uBAyGA,sBAzGA;;AAAA;AAAA;AAAA,uBA0GA,kCA1GA;;AAAA;AA0GA;AACA;AACA;;AA5GA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AA8GA;AACA;AACAC,qBAhHA,6BAgHAC,UAhHA,EAgHA;AACA;AACA;AACA;;AACA;AAAA;AAAA;AAAA;AACA;AACAC,2BADA;AAEAvD,+BAFA;AAGAwD,yBAHA;AAIAF,yCAJA;AAKAG,wBALA;AAMAC,kBANA;AAOAC,4BAPA;AAQAC,wBARA;AASAC;AATA;AAWA;AACAC,sCADA;AAEAC,mDAFA;AAGAC,oDAHA;AAIAC;AACApE,oCADA;AAEAqE,yBAFA;AAGAC;AAHA;AAJA;AAUA;AACA;AACA,KA5IA;AA6IA;AACAC,kBA9IA,4BA8IA;AACA;AACA;AACA;AAjJA;AA1CA","names":["name","data","pusher","roomID","roomName","isPushingStream","updateTimer","pusherTime","time","recordTimer","isMute","isStartCamera","computed","mapState","user","groupLiveInfo","anchorAvatar","created","mounted","beforeDestroy","clearInterval","components","liveHeader","methods","init","userID","onRTCConnectionStateChanged","event","onRTCClientBanned","onRTCError","setRenderView","elementID","audio","video","then","el","catch","startCamera","stopCamera","startMicrophone","stopMicrophone","generateRoomID","min","max","createRoom","axios","destroyRoom","updateRoom","createGroupLiveAvChatRoom","groupID","type","startPushStream","streamID","url","encodeURIComponent","stopPushStream","stopPush","sendNoticeToGroup","roomStatus","roomId","roomCover","anchorName","version","roomType","anchorId","businessID","to","conversationType","priority","payload","description","extension","recordLiveTime"],"sourceRoot":"src/components/group-live/components","sources":["live-pusher.vue"],"sourcesContent":["<template>\r\n  <div class=\"pusher\">\r\n    <div class=\"header-bar\">\r\n      <live-header fr=\"pusher\" :pusherTime=\"pusherTime\" :isPushingStream=\"isPushingStream\" :stopPushStream=\"stopPushStream\"/>\r\n      <div class=\"input-name-box\" v-show=\"!isPushingStream\">\r\n        <img class=\"avatar\" :src=\"anchorAvatar\" alt=\"\" />\r\n        <input class=\"room-name\" v-model=\"roomName\" placeholder=\"标题有趣吸引人气\" />\r\n      </div>\r\n    </div>\r\n    <div id=\"video-container\" class=\"video-container\">\r\n    </div>\r\n    <div class=\"setting-bar\">\r\n      <!-- <live-share v-if=\"isPushingStream\" /> -->\r\n      <div>\r\n        <div v-if=\"!isPushingStream\"  class=\"pusher-start cursor\" @click=\"startPushStream\">\r\n          <img class=\"pusher-icon\" src=\"../../../assets/image/web-pusher-start.png\">\r\n          <span class=\"play-text\">开始直播</span>\r\n        </div>\r\n        <div v-else class=\"pusher-start cursor\" @click=\"stopPushStream\">\r\n          <img class=\"pusher-icon\" src=\"../../../assets/image/web-pusher-stop.png\">\r\n          <span class=\"play-text\">结束直播</span>\r\n        </div>\r\n      </div>\r\n      <div>\r\n        <div v-if=\"isMute\" class=\"pusher-mic cursor\" @click=\"startMicrophone\">\r\n          <img class=\"pusher-icon\" src=\"../../../assets/image/close-mic.png\">\r\n          <span class=\"mic-text\">麦克风</span>\r\n        </div>\r\n        <div v-else class=\"pusher-mic cursor\" @click=\"stopMicrophone\">\r\n          <img class=\"pusher-icon\" src=\"../../../assets/image/open-mic.png\">\r\n          <span class=\"mic-text\">麦克风</span>\r\n        </div>\r\n      </div>\r\n      <div>\r\n        <div v-if=\"isStartCamera\" class=\"pusher-mic cursor\" style=\"right: 300px\" @click=\"startCamera\">\r\n          <svg width=\"16px\" height=\"16px\" viewBox=\"0 0 16 16\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\r\n            <title>摄像头关闭</title>\r\n            <g id=\"页面-1\" stroke=\"none\" stroke-width=\"1\" fill=\"none\" fill-rule=\"evenodd\">\r\n              <g id=\"j进度条备份\" transform=\"translate(-751.000000, -22.000000)\">\r\n                <g id=\"编组-9\" transform=\"translate(751.000000, 22.000000)\">\r\n                  <g id=\"编组-11\">\r\n                    <path d=\"M15,7.5 C15,11.6421356 11.6421356,15 7.5,15 C6.57050116,15 5.68049488,14.8309122 4.85906245,14.5218179 L6.43561423,12.8970864 C6.77997642,12.9646116 7.13585551,13 7.5,13 C10.5375661,13 13,10.5375661 13,7.5 C13,7.0789865 12.9526952,6.66902162 12.8631108,6.27513055 L14.4397563,4.65055194 C14.8008626,5.52907797 15,6.49128347 15,7.5 Z M7.5,0 C9.88955323,0 12.0181001,1.11750106 13.3915381,2.85840064 L11.9813778,4.31063973 C10.984196,2.91201268 9.34860401,2 7.5,2 C4.46243388,2 2,4.46243388 2,7.5 C2,9.40763139 2.97118511,11.0884303 4.44609208,12.0749336 L3.03637255,13.5276986 C1.1940301,12.1611583 0,9.97001947 0,7.5 C0,3.35786438 3.35786438,0 7.5,0 Z\" id=\"形状结合\" fill=\"#8A9099\" fill-rule=\"nonzero\"></path>\r\n                    <path d=\"M7.5,5 C8.54350703,5 9.43769004,5.63933214 9.81221332,6.5476607 L6.61637488,9.83935679 C5.67174144,9.48236445 5,8.56962904 5,7.5 C5,6.11928813 6.11928813,5 7.5,5 Z\" id=\"形状结合\" fill=\"#8A9099\"></path>\r\n                    <path d=\"\" id=\"形状结合\" stroke=\"#8A9099\" stroke-width=\"2\"></path>\r\n                    <line x1=\"13.3137085\" y1=\"2\" x2=\"2\" y2=\"13.3137085\" id=\"直线-5\" stroke=\"#8A9099\" stroke-width=\"2\" stroke-linecap=\"square\"></line>\r\n                  </g>\r\n                </g>\r\n              </g>\r\n            </g>\r\n          </svg>\r\n          <span class=\"mic-text\">摄像头</span>\r\n        </div>\r\n        <div v-else class=\"pusher-mic cursor\" style=\"right: 300px\" @click=\"stopCamera\">\r\n          <img class=\"pusher-icon\" src=\"../../../assets/image/camera-open.png\">\r\n          <span class=\"mic-text\">摄像头</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport axios from 'axios'\r\nimport { mapState } from 'vuex'\r\nimport liveHeader from './live-header'\r\n// import liveShare from './live-share'\r\nimport { formatTime } from '../../../utils/date.js'\r\n\r\nexport default {\r\n  name: 'livePusher',\r\n  data() {\r\n    return {\r\n      pusher: null,\r\n      roomID: 0,\r\n      roomName: '',\r\n      isPushingStream: false, // 是否正在推流\r\n      updateTimer: 0,\r\n      pusherTime: '00:00:00',\r\n      time: 0, // 直播时长 秒\r\n      recordTimer: null, // 记录直播时长\r\n      isMute: false,   //是否禁言\r\n      isStartCamera: true\r\n    }\r\n  },\r\n  computed: {\r\n    ...mapState({\r\n      user: state => state.user,\r\n      groupLiveInfo: state => state.groupLive.groupLiveInfo\r\n    }),\r\n    anchorAvatar() {\r\n      return this.user.currentUserProfile.avatar || 'https://imgcache.qq.com/open/qcloud/video/act/webim-avatar/avatar-2.png'\r\n    }\r\n  },\r\n  created() {\r\n    this.$store.commit('resetGroupLiveInfo', { roomID: 0 })\r\n  },\r\n  mounted() {\r\n    this.init()\r\n  },\r\n  async beforeDestroy() {\r\n    if (this.isPushingStream) {\r\n      clearInterval(this.updateTimer)\r\n      clearInterval(this.recordTimer)\r\n      await this.stopPush()\r\n    }\r\n  },\r\n  components: {\r\n    liveHeader,\r\n    // liveShare,\r\n  },\r\n  methods: {\r\n    // 初始化\r\n    init() {\r\n      this.pusher = this.TWebLive.createPusher({\r\n        userID: this.user.userID\r\n      })\r\n      this.setRenderView()\r\n      this.pusher.on(this.TWebLive.EVENT.RTC_CONNECTION_STATE_CHANGED, this.onRTCConnectionStateChanged)\r\n      this.pusher.on(this.TWebLive.EVENT.RTC_CLIENT_BANNED, this.onRTCClientBanned)\r\n      this.pusher.on(this.TWebLive.EVENT.RTC_CLIENT_ERROR, this.onRTCError)\r\n    },\r\n    // eslint-disable-next-line no-unused-vars\r\n    onRTCConnectionStateChanged(event) {},\r\n    // eslint-disable-next-line no-unused-vars\r\n    onRTCClientBanned(event) {},\r\n    // eslint-disable-next-line no-unused-vars\r\n    onRTCError(event) {},\r\n    //开启本地预览\r\n    setRenderView() {\r\n      this.pusher.setRenderView({\r\n        elementID: 'video-container',\r\n        audio: true,\r\n        video: true\r\n      }).then(() => {\r\n        // 设置背景\r\n       let el = window.document.getElementById('video-container').childNodes\r\n        el[0].style.backgroundColor = 'rgba(0,0,0,0)'\r\n        this.isStartCamera = false\r\n      }).catch(() => {})\r\n    },\r\n    // 摄像头、麦克风操作\r\n    startCamera() {\r\n      this.pusher.startCamera().then(() => {\r\n        this.isStartCamera = false\r\n      }).catch(() => {})\r\n    },\r\n    stopCamera() {\r\n      this.pusher.stopCamera().then(() => {\r\n        this.isStartCamera = true\r\n      }).catch(() => {})\r\n    },\r\n    startMicrophone() {\r\n      this.pusher.startMicrophone().then(() => {\r\n        this.isMute = false\r\n      }).catch(() => {})\r\n    },\r\n    stopMicrophone() {\r\n      this.pusher.stopMicrophone().then(() => {\r\n        this.isMute = true\r\n      }).catch(() => {})\r\n    },\r\n    // 生成roomID\r\n    generateRoomID(min, max) {\r\n      return Math.floor(Math.random()*(max - min) + min).toString()\r\n    },\r\n    // 创建直播房间\r\n    async createRoom() {\r\n      this.roomID = this.generateRoomID(1000, 2000000000)\r\n      this.roomName = this.roomName ? this.roomName : `${this.user.userID}的直播`\r\n      await axios (`https://service-62h5r0ea-1252463788.gz.apigw.tencentcs.com/release/forTestAdvanced?method=createRoom&appId=${this.user.sdkAppID}&type=groupLive&title=${this.roomName}&anchorId=${this.user.userID}&roomId=${this.roomID}`)\r\n      this.$store.commit('updateGroupLiveInfo', { roomID: this.roomID, roomName: this.roomName })\r\n      this.createGroupLiveAvChatRoom()\r\n    },\r\n    // 解散直播间\r\n    async destroyRoom() {\r\n      await axios (`https://service-c2zjvuxa-1252463788.gz.apigw.tencentcs.com/release/forTest?method=destroyRoom&appId=${this.user.sdkAppID}&type=groupLive&roomId=${this.roomID}`)\r\n    },\r\n    // 更新直播间 10s 上报一次，心跳保活，如果不上报，后台检测不到心跳会销毁房间\r\n    updateRoom() {\r\n      axios (`https://service-c2zjvuxa-1252463788.gz.apigw.tencentcs.com/release/forTest?method=updateRoom&appId=${this.user.sdkAppID}&type=groupLive&roomId=${this.roomID}`)\r\n    },\r\n    // 创建直播互动群\r\n    async createGroupLiveAvChatRoom() {\r\n      await this.tim.createGroup({\r\n        name: this.roomName,\r\n        groupID: this.roomID,\r\n        type: this.TIM.TYPES.GRP_AVCHATROOM,\r\n      })\r\n      this.$bus.$emit('join-group-live-avchatroom')\r\n    },\r\n    //开始推流\r\n    async startPushStream() {\r\n      await this.createRoom()\r\n      //streamID 拼接规则： sdkappid_roomid_userid_main\r\n      const streamID = `${this.user.sdkAppID}_${this.roomID}_${this.user.userID}_main`\r\n      // 对userSig进行encode,防止userSig中带有+时被浏览器解析为空格，导致trtc ws连接失败\r\n      const url = `room://livedomainname=tuikit.qcloud.com&sdkappid=${this.user.sdkAppID}&roomid=${this.roomID}&userid=${this.user.userID}&usersig=${encodeURIComponent(this.user.userSig)}&streamid=${streamID}`\r\n      this.pusher.startPush(url).then(() => {\r\n        this.isPushingStream = true\r\n        this.sendNoticeToGroup(1)\r\n        this.updateTimer = setInterval(() => {\r\n          this.updateRoom()\r\n        }, 10000)\r\n        this.recordTimer = setInterval(() => {\r\n          this.recordLiveTime()\r\n        }, 1000)\r\n      }).catch(() => {})\r\n    },\r\n    // 停止推流\r\n    stopPushStream() {\r\n      // 派发关闭浮层组件事件\r\n      this.$bus.$emit('close-group-live')\r\n    },\r\n    async stopPush() {\r\n      await this.destroyRoom()\r\n      await this.pusher.stopPush()\r\n      await this.tim.dismissGroup(this.roomID) // 解散直播群组\r\n      this.isPushingStream = false\r\n      this.sendNoticeToGroup(0)\r\n    },\r\n    // 给群内发送开始直播、结束直播自定义消息\r\n    // roomStatus 1 开始直播 0 结束直播\r\n    sendNoticeToGroup(roomStatus) {\r\n      if (!this.groupLiveInfo.groupID) {\r\n        return\r\n      }\r\n      const { userID, nick, avatar } = this.user.currentUserProfile\r\n      const form = {\r\n        roomId: this.roomID,\r\n        roomName: this.roomName,\r\n        roomCover: avatar,\r\n        roomStatus: `${roomStatus}`,\r\n        anchorName: nick,\r\n        version: 4,\r\n        roomType: 'liveRoom',\r\n        anchorId: userID,\r\n        businessID: 'group_live'\r\n      }\r\n      const message = this.tim.createCustomMessage({\r\n        to: this.groupLiveInfo.groupID,\r\n        conversationType: this.TIM.TYPES.CONV_GROUP,\r\n        priority: this.TIM.TYPES.MSG_PRIORITY_NORMAL,\r\n        payload: {\r\n          data: JSON.stringify(form),\r\n          description: '',\r\n          extension: '',\r\n        },\r\n      })\r\n      this.$store.commit('pushCurrentMessageList', message)\r\n      this.tim.sendMessage(message).then(() => {}).catch(() => {})\r\n    },\r\n    // 记录直播时间\r\n    recordLiveTime () {\r\n      this.time++\r\n      this.pusherTime = formatTime(this.time)\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"stylus\"  scoped>\r\n  ::-webkit-input-placeholder {\r\n    color: #fff\r\n  }\r\n  ::-moz-input-placeholder {\r\n    color: #fff\r\n  }\r\n  ::-ms-input-placeholder {\r\n    color: #fff\r\n  }\r\n  .cursor {\r\n    cursor: pointer;\r\n  }\r\n  .active {\r\n    color: #2d8cf0\r\n  }\r\n  .pusher {\r\n    position relative\r\n    width 100%\r\n    height 100%\r\n    background rgba(0, 0, 0, 1)\r\n    display flex\r\n    flex-flow column\r\n    flex-direction column\r\n    .video-container {\r\n      position relative\r\n      height calc(100% - 125px)\r\n      .stop-camera {\r\n        position absolute\r\n        top 0\r\n        right 0\r\n        bottom 0\r\n        left 0\r\n        background-color #ffffff\r\n        display flex\r\n        flex-direction column\r\n        justify-content center\r\n        align-items center\r\n      }\r\n    }\r\n    .header-bar {\r\n      position: relative;\r\n      width 100%\r\n      height 70px\r\n      background-color #363e47\r\n      padding 10px 10px 10px 20px\r\n      .input-name-box{\r\n        position absolute\r\n        left 0\r\n        top 0px\r\n        width calc(100% - 100px)\r\n        height 100%\r\n        display flex\r\n        align-items center\r\n        z-index 99\r\n        padding 10px 20px\r\n        .avatar{\r\n          width 50px\r\n          height 50px\r\n          border-radius 50%\r\n          margin 0px 10px 0px 0px\r\n        }\r\n        .room-name{\r\n          border hidden\r\n          outline-style none\r\n          height 40px\r\n          width  60%\r\n          font-size 20px\r\n          color #fff\r\n          background rgba(255, 255,255, 0)\r\n          border-bottom 1px solid #fff\r\n        }\r\n      }\r\n    }\r\n    .setting-bar {\r\n      position: relative;\r\n      width 100%\r\n      height 55px\r\n      background-color #363e47\r\n      .pusher-start {\r\n        position: absolute;\r\n        right 0\r\n        bottom 0\r\n        width 210px\r\n        height 55px\r\n        background #5cadff\r\n        display: flex;\r\n        justify-content: center;\r\n        align-items: center;\r\n      }\r\n      .pusher-mic{\r\n        position: absolute;\r\n        right 220px\r\n        bottom 0\r\n        /*width 210px*/\r\n        height 55px\r\n        display: flex;\r\n        justify-content: center;\r\n        align-items: center\r\n        padding 0 10px\r\n      }\r\n      .play-text{\r\n        font-size 16px\r\n        color #ffffff\r\n        margin-left 5px\r\n      }\r\n      .pusher-icon{\r\n        width 14px\r\n        height 14px\r\n      }\r\n      .mic-text{\r\n        font-size 14px\r\n        color #8A9099\r\n        margin-left 5px\r\n      }\r\n    }\r\n  }\r\n</style>\r\n"]}]}