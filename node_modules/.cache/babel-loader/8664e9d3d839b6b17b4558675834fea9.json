{"remainingRequest":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\babel-loader\\lib\\index.js!D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\message\\trtc-calling\\calling-index.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\message\\trtc-calling\\calling-index.vue","mtime":1649851412195},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\babel.config.js","mtime":1649851412081},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\babel-loader\\lib\\index.js","mtime":1649851455045},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js","mtime":1649851455309}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/es6.array.find-index\";\nimport \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"D:/project/softwareDevelopment/IM-Web/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/web.dom.iterable\";\nimport _defineProperty from \"D:/project/softwareDevelopment/IM-Web/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { mapGetters, mapState } from 'vuex';\nimport { formatDuration } from \"../../../utils/formatDuration\";\nexport default {\n  name: 'CallLayer',\n  data: function data() {\n    return {\n      timeout: null,\n      callType: 1,\n      //1:audio，2:video\n      Trtc: undefined,\n      isCamOn: true,\n      isMicOn: true,\n      isInvitedMicOn: true,\n      maskShow: false,\n      isLocalMain: true,\n      // 本地视频是否是主屏幕显示\n      start: 0,\n      end: 0,\n      duration: 0,\n      hangUpTimer: 0,\n      // 通话计时id\n      ready: false,\n      dialling: false,\n      // 是否拨打电话中\n      calling: false,\n      // 是否通话中\n      isDialled: false,\n      // 是否被呼叫\n      inviteID: '',\n      inviteData: {},\n      sponsor: '',\n      //发起者\n      invitedUserID: [],\n      //被邀请者\n      invitedNick: '',\n      invitedUserInfo: [],\n      defaultAvatar: 'https://imgcache.qq.com/open/qcloud/video/act/webim-avatar/avatar-3.png',\n      viewLocalDomID: '',\n      callingUserList: [],\n      // 参加通话的人 ,不包括自己\n      callingType: 'C2C',\n      //区分多人和C2C通话的UI样式\n      isStartLocalView: false,\n      //本地是否开启\n      callingTips: {\n        callEnd: 1,\n        //通话结束\n        callTimeout: 5\n      }\n    };\n  },\n  computed: _objectSpread(_objectSpread(_objectSpread({}, mapGetters(['toAccount', 'currentConversationType'])), mapState({\n    currentConversation: function currentConversation(state) {\n      return state.conversation.currentConversation;\n    },\n    currentUserProfile: function currentUserProfile(state) {\n      return state.user.currentUserProfile;\n    },\n    callingInfo: function callingInfo(state) {\n      return state.conversation.callingInfo;\n    },\n    userID: function userID(state) {\n      return state.user.userID;\n    },\n    userSig: function userSig(state) {\n      return state.user.userSig;\n    },\n    videoRoom: function videoRoom(state) {\n      return state.video.videoRoom;\n    },\n    sdkAppID: function sdkAppID(state) {\n      return state.user.sdkAppID;\n    }\n  })), {}, {\n    formatDurationStr: function formatDurationStr() {\n      return formatDuration(this.duration);\n    },\n    myAvatar: function myAvatar() {\n      return this.currentUserProfile.avatar || this.defaultAvatar;\n    },\n    myNick: function myNick() {\n      return this.currentUserProfile.nick || this.userID;\n    }\n  }),\n  created: function created() {\n    this.initListener();\n  },\n  watch: {\n    callingUserList: {\n      handler: function handler(newValue) {\n        var _this = this;\n\n        if (newValue.length < 2 && this.calling) {\n          //单人通话\n          this.$nextTick(function () {\n            var elementId = \"video-\".concat(newValue[0]);\n            var element = window.document.getElementById(elementId);\n            var local = window.document.getElementById('local');\n            var group_element = window.document.getElementById('small-group'); // element.addEventListener('click', this.changeMainVideo)\n            // local.addEventListener('click', this.changeMainVideo)\n\n            if (!element || !element.classList) {\n              return;\n            }\n\n            if (!local || !local.classList) {\n              return;\n            }\n\n            element && element.classList.remove('video-box');\n            local && local.classList.remove('video-box');\n            group_element && group_element.classList.add('small-group_box');\n            _this.isLocalMain ? element.classList.add('big') : element.classList.add('small');\n            _this.isLocalMain ? local.classList.add('small') : element.classList.add('big');\n          });\n          return;\n        }\n\n        if (newValue.length >= 2 && this.calling) {\n          var group_element = window.document.getElementById('small-group');\n          group_element && group_element.classList.remove('small-group_box');\n          var elements = window.document.getElementById('small-group').childNodes;\n          elements.forEach(function (item, index) {\n            if (index === 0) {\n              item.classList.remove('small');\n            }\n\n            item.classList.remove('big');\n            item.classList.add('video-box');\n          });\n        }\n      },\n      deep: true,\n      immediate: true\n    }\n  },\n  destroyed: function destroyed() {\n    var _this2 = this;\n\n    this.removeListener();\n    window.addEventListener('beforeunload', function () {\n      _this2.videoCallLogOut();\n    });\n    window.addEventListener('leave', function () {\n      _this2.videoCallLogOut();\n    });\n  },\n  mounted: function mounted() {\n    this.$bus.$on('video-call', this.videoCalling); // 发起通话\n\n    this.$bus.$on('audio-call', this.audioCalling); // 发起通话\n  },\n  beforeDestroy: function beforeDestroy() {\n    this.$bus.$off('video-call', this.videoCalling);\n    this.$bus.$off('audio-call', this.audioCalling); // 发起通话\n  },\n  methods: {\n    videoCallLogOut: function videoCallLogOut() {\n      // 针对，刷新页面，关闭Tab，登出情况下，通话断开的逻辑\n      if (this.dialling || this.calling) {\n        this.leave();\n      }\n\n      if (this.isDialled) {\n        this.refuse();\n      }\n    },\n    initListener: function initListener() {\n      // sdk内部发生了错误\n      this.trtcCalling.on(this.TRTCCalling.EVENT.ERROR, this.handleError); // 被邀请进行通话\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.INVITED, this.handleNewInvitationReceived); // 有用户同意进入通话，那么会收到此回调\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.USER_ENTER, this.handleUserEnter); // 如果有用户同意离开通话，那么会收到此回调\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.USER_LEAVE, this.handleUserLeave); // 用户拒绝通话\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.REJECT, this.handleInviteeReject); //邀请方忙线\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.LINE_BUSY, this.handleInviteeLineBusy); // 作为被邀请方会收到，收到该回调说明本次通话被取消了\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.CALLING_CANCEL, this.handleInviterCancel); // 重复登陆，收到该回调说明被踢出房间\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.KICKED_OUT, this.handleKickedOut); // 作为邀请方会收到，收到该回调说明本次通话超时未应答\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.CALLING_TIMEOUT, this.handleCallTimeout); // 邀请用户无应答\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.NO_RESP, this.handleNoResponse); // 收到该回调说明本次通话结束了\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.CALLING_END, this.handleCallEnd); // 远端用户开启/关闭了摄像头, 会收到该回调\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.USER_VIDEO_AVAILABLE, this.handleUserVideoChange); // 远端用户开启/关闭了麦克风, 会收到该回调\n\n      this.trtcCalling.on(this.TRTCCalling.EVENT.USER_AUDIO_AVAILABLE, this.handleUserAudioChange);\n    },\n    removeListener: function removeListener() {\n      this.trtcCalling.off(this.TRTCCalling.EVENT.ERROR, this.handleError);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.INVITED, this.handleNewInvitationReceived);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.USER_ENTER, this.handleUserEnter);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.USER_LEAVE, this.handleUserLeave);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.REJECT, this.handleInviteeReject);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.LINE_BUSY, this.handleInviteeLineBusy);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.CALLING_CANCEL, this.handleInviterCancel);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.KICKED_OUT, this.handleKickedOut);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.CALLING_TIMEOUT, this.handleCallTimeout);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.NO_RESP, this.handleNoResponse);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.CALLING_END, this.handleCallEnd);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.USER_VIDEO_AVAILABLE, this.handleUserVideoChange);\n      this.trtcCalling.off(this.TRTCCalling.EVENT.USER_AUDIO_AVAILABLE, this.handleUserAudioChange);\n    },\n    handleError: function handleError() {},\n    // 被呼叫  接听方\n    handleNewInvitationReceived: function () {\n      var _handleNewInvitationReceived = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee(payload) {\n        var inviteID, sponsor, inviteData, userIDList, isGroupCall;\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                inviteID = payload.inviteID, sponsor = payload.sponsor, inviteData = payload.inviteData, userIDList = payload.userIDList, isGroupCall = payload.isGroupCall;\n                this.inviteID = inviteID;\n                this.inviteData = inviteData;\n                this.callType = inviteData.callType;\n                this.sponsor = sponsor;\n                this.invitedUserID = JSON.parse(JSON.stringify(userIDList)); //被邀请者\n\n                this.callingInfo.type = isGroupCall ? this.TIM.TYPES.CONV_GROUP : this.TIM.TYPES.CONV_C2C;\n                this.changeState('isDialled', true);\n\n              case 8:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function handleNewInvitationReceived(_x) {\n        return _handleNewInvitationReceived.apply(this, arguments);\n      }\n\n      return handleNewInvitationReceived;\n    }(),\n    accept: function accept() {\n      var _this3 = this;\n\n      this.trtcCalling.accept({\n        inviteID: this.inviteID,\n        roomID: this.inviteData.roomID,\n        callType: this.inviteData.callType\n      }).then(function (res) {\n        // this.callType = this.inviteData.callType\n        _this3.changeState('calling', true);\n\n        res.data.message.nick = _this3.currentUserProfile.nick;\n\n        _this3.$store.commit('pushCurrentMessageList', res.data.message);\n      });\n    },\n    reject: function reject() {\n      var _this4 = this;\n\n      var callType = this.inviteData.callType;\n      this.trtcCalling.reject({\n        inviteID: this.inviteID,\n        isBusy: false,\n        callType: callType\n      }).then(function (res) {\n        res.data.message.nick = _this4.currentUserProfile.nick;\n\n        _this4.$store.commit('pushCurrentMessageList', res.data.message);\n      });\n    },\n    handleDebounce: function handleDebounce(func, wait) {\n      var context = this;\n      var args = arguments;\n      if (this.timeout) clearTimeout(this.timeout);\n      this.timeout = setTimeout(function () {\n        func.apply(context, args);\n      }, wait);\n    },\n    // 双方建立连接\n    handleUserEnter: function handleUserEnter(_ref) {\n      var _this5 = this;\n\n      var userID = _ref.userID;\n      this.changeState('dialling', true);\n      this.isAccept(); // 判断是否为多人通话\n\n      if (this.callingUserList.length >= 2) {\n        this.callingType = this.TIM.TYPES.CONV_GROUP;\n      }\n\n      if (this.callingUserList.indexOf(userID) === -1) {\n        if (this.callType === this.TRTCCalling.CALL_TYPE.AUDIO_CALL) {\n          this.getUserAvatar(userID);\n        } else {\n          this.callingUserList.push(userID);\n        }\n      }\n\n      if (this.callType === this.TRTCCalling.CALL_TYPE.VIDEO_CALL) {\n        this.$nextTick(function () {\n          if (!_this5.isStartLocalView) {\n            _this5.startLocalView(); //本地只开启一次\n\n          }\n\n          _this5.startRemoteView(userID); //远端多次拉流\n\n        });\n      }\n    },\n    // 通话已建立\n    handleUserLeave: function handleUserLeave(_ref2) {\n      var userID = _ref2.userID;\n\n      if (this.callType === this.TRTCCalling.CALL_TYPE.AUDIO_CALL) {\n        // 语音通话\n        var _index = this.invitedUserInfo.findIndex(function (item) {\n          return item.userID === userID;\n        });\n\n        if (_index >= 0) {\n          this.invitedUserInfo.splice(_index, 1);\n        }\n\n        return;\n      }\n\n      var index = this.callingUserList.findIndex(function (item) {\n        return item === userID;\n      });\n\n      if (index >= 0) {\n        this.callingUserList.splice(index, 1);\n      }\n    },\n    // 通知呼叫方，未接通\n    //userID:invitee(被邀请者）\n    handleInviteeReject: function handleInviteeReject(_ref3) {\n      var userID = _ref3.userID;\n\n      if (this.userID === this.sponsor) {\n        // 发起者\n        this.setCallingstatus(userID);\n        this.$store.commit('showMessage', {\n          message: \"\".concat(userID, \"\\u62D2\\u7EDD\\u901A\\u8BDD\")\n        });\n      }\n    },\n    setCallingstatus: function setCallingstatus(userID) {\n      var _index = this.invitedUserID.indexOf(userID);\n\n      if (_index >= 0) {\n        this.invitedUserID.splice(_index, 1);\n      }\n\n      if (this.invitedUserID.length === 0) {\n        this.changeState('isDialled', false);\n        this.changeState('dialling', false);\n      }\n    },\n    // 通知呼叫方，对方在忙碌，未接通\n    handleInviteeLineBusy: function handleInviteeLineBusy(_ref4) {\n      var sponsor = _ref4.sponsor,\n          userID = _ref4.userID;\n\n      // A call B,C call A, A在忙线， 拒绝通话，对于呼叫者C收到通知，XXX在忙线\n      if (sponsor === this.userID) {\n        this.setCallingstatus(userID);\n        this.$store.commit('showMessage', {\n          message: \"\".concat(userID, \"\\u5FD9\\u7EBF\")\n        });\n      }\n    },\n    // 通知被呼叫方，邀请被取消，未接通\n    handleInviterCancel: function handleInviterCancel() {\n      // 邀请被取消\n      this.changeState('isDialled', false);\n      this.$store.commit('showMessage', {\n        message: '通话已取消'\n      });\n    },\n    handleKickedOut: function handleKickedOut() {// //重复登陆，被踢出房间\n      // this.trtcCalling.logout();\n      // this.$store.commit(\"userLogoutSuccess\");\n    },\n    // 当自己收到对端超时的信令时，或者当我是被邀请者但自己超时了，通知上层通话超时\n    // case: A呼叫B，B在线，B超时未响应，B会触发该事件，A也会触发该事件\n    handleCallTimeout: function handleCallTimeout(_ref5) {\n      var _this6 = this;\n\n      var userIDList = _ref5.userIDList;\n\n      if (this.calling) {\n        return;\n      }\n\n      if (this.userID === this.sponsor) {\n        // 该用户是邀请者\n        userIDList.forEach(function (userID) {\n          _this6.setCallingstatus(userID); //超时未接听\n\n        });\n        return;\n      } //用户是被邀请者\n\n\n      if (userIDList.indexOf(this.userID) > -1) {\n        //当超时者是自己时，添加消息\n        //会话列表切换后发消息\n        this.toAccount && this.sendMessage(this.userID, '', this.callingTips.callTimeout);\n      }\n\n      this.changeState('isDialled', false);\n    },\n    // 双方，通话已建立, 通话结束\n    handleCallEnd: function handleCallEnd(_ref6) {\n      var userID = _ref6.userID,\n          callEnd = _ref6.callEnd;\n\n      // 自己挂断的要补充消息  被邀请者都无应答时结束\n      // 历史消息中没有通话结束\n      if (userID === this.userID && this.invitedUserID.length === 0 || this.callingUserList === 0) {\n        this.sendMessage(userID, callEnd, this.callingTips.callEnd);\n      } //   this.changeState('isDialled', false)\n      //   this.changeState('calling', false)\n\n\n      this.changeState('dialling', false);\n      this.isMicOn = true;\n      this.isCamOn = true;\n      this.maskShow = false;\n      this.isStartLocalView = false; // this.$store.commit('showMessage', {\n      //   message: '通话已结束'\n      // })\n    },\n    // 自己超时且是邀请发起者，需主动挂断，并通知上层对端无应答\n    handleNoResponse: function handleNoResponse(_ref7) {\n      var _this7 = this;\n\n      var sponsor = _ref7.sponsor,\n          userIDList = _ref7.userIDList;\n\n      //邀请者\n      if (sponsor === this.userID) {\n        userIDList.forEach(function (userID) {\n          _this7.setCallingstatus(userID);\n        });\n\n        if (userIDList.indexOf(this.userID) === -1) {\n          //当超时者是自己时，添加消息\n          this.sendMessage(userIDList, '', this.callingTips.callTimeout);\n        }\n      }\n    },\n    handleUserVideoChange: function handleUserVideoChange() {},\n    handleUserAudioChange: function handleUserAudioChange(payload) {\n      var _index = this.invitedUserInfo.findIndex(function (item) {\n        return item.userID === payload.userID;\n      });\n\n      if (_index >= 0) {\n        this.invitedUserInfo[_index].isInvitedMicOn = payload.isAudioAvailable;\n      } // this.isInvitedMicOn = payload.isAudioAvailable\n\n    },\n    // 播放本地流\n    startLocalView: function startLocalView() {\n      var _this8 = this;\n\n      this.trtcCalling.startLocalView({\n        userID: this.userID,\n        videoViewDomID: 'local'\n      }).then(function () {\n        _this8.isStartLocalView = true;\n      });\n    },\n    // 没有用到\n    stopLocalView: function stopLocalView() {\n      this.trtcCalling.stopLocalView({\n        userID: this.userID,\n        videoViewDomID: this.viewLocalDomID\n      });\n    },\n    // 播放远端流\n    startRemoteView: function startRemoteView(userID) {\n      this.trtcCalling.startRemoteView({\n        userID: userID,\n        videoViewDomID: \"video-\".concat(userID)\n      }).then(function () {});\n    },\n    //没有用到\n    stopRemoteView: function stopRemoteView(userID) {\n      this.trtcCalling.stopRemoteView({\n        userID: this.userID,\n        videoViewDomID: \"video-\".concat(userID)\n      });\n    },\n    //获取被呼叫者信息\n    getUserAvatar: function getUserAvatar(userID) {\n      var _this9 = this;\n\n      var _index = this.invitedUserInfo.findIndex(function (item) {\n        return item.userID === userID;\n      });\n\n      if (_index >= 0) {\n        return;\n      }\n\n      var _userIDList = [userID];\n      var promise = this.tim.getUserProfile({\n        userIDList: _userIDList // 请注意：即使只拉取一个用户的资料，也需要用数组类型，例如：userIDList: ['user1']\n\n      });\n      promise.then(function (imResponse) {\n        if (imResponse.data[0]) {\n          _this9.invitedUserInfo.push(imResponse.data[0]);\n        }\n      }).catch(function () {});\n    },\n    changeState: function changeState(state, boolean) {\n      var _this10 = this;\n\n      var stateList = ['dialling', 'isDialled', 'calling'];\n      stateList.forEach(function (item) {\n        _this10[item] = item === state ? boolean : false;\n      });\n      this.$store.commit('UPDATE_ISBUSY', stateList.some(function (item) {\n        return _this10[item];\n      })); // 若stateList 中存在 true , isBusy 为 true\n    },\n    videoCalling: function videoCalling() {\n      var _this11 = this;\n\n      // 发起通话\n      // 初始化被邀请者\n      this.invitedUserID = JSON.parse(JSON.stringify(this.callingInfo.memberList));\n      this.sponsor = this.userID;\n\n      if (this.calling) {\n        // 避免通话按钮多次快速的点击\n        return;\n      }\n\n      this.callType = this.TRTCCalling.CALL_TYPE.VIDEO_CALL;\n      this.isLocalMain = true; // 可设置超时\n\n      if (this.callingInfo.type === this.TIM.TYPES.CONV_C2C) {\n        this.trtcCalling.call({\n          userID: this.callingInfo.memberList[0],\n          type: this.callType,\n          timeout: 30\n        }).then(function (res) {\n          res.data.message.nick = _this11.currentUserProfile.nick;\n\n          _this11.$store.commit('pushCurrentMessageList', res.data.message);\n\n          _this11.changeState('dialling', true);\n        });\n      } else {\n        this.trtcCalling.groupCall({\n          userIDList: this.callingInfo.memberList,\n          type: this.callType,\n          groupID: this.currentConversation.groupProfile.groupID,\n          timeout: 30\n        }).then(function (res) {\n          res.data.message.nick = _this11.currentUserProfile.nick;\n\n          _this11.$store.commit('pushCurrentMessageList', res.data.message);\n\n          _this11.changeState('dialling', true);\n        });\n      }\n    },\n    audioCalling: function audioCalling() {\n      var _this12 = this;\n\n      // 发起通话\n      // 初始化被邀请者\n      this.invitedUserID = this.callingInfo.memberList;\n      this.sponsor = this.userID;\n\n      if (this.calling) {\n        // 避免通话按钮多次快速的点击\n        return;\n      } // // 发起者获取被邀约人信息\n      // this.getUserAvatar()\n      // 可设置超时\n\n\n      this.callType = this.TRTCCalling.CALL_TYPE.AUDIO_CALL;\n\n      if (this.callingInfo.type === 'C2C') {\n        this.trtcCalling.call({\n          userID: this.callingInfo.memberList[0],\n          type: this.callType,\n          timeout: 30\n        }).then(function (res) {\n          _this12.changeState('dialling', true);\n\n          res.data.message.nick = _this12.currentUserProfile.nick;\n\n          _this12.$store.commit('pushCurrentMessageList', res.data.message);\n        });\n      } else {\n        this.trtcCalling.groupCall({\n          userIDList: this.callingInfo.memberList,\n          type: this.callType,\n          groupID: this.currentConversation.groupProfile.groupID,\n          timeout: 30\n        }).then(function (res) {\n          _this12.changeState('dialling', true);\n\n          res.data.message.nick = _this12.currentUserProfile.nick;\n\n          _this12.$store.commit('pushCurrentMessageList', res.data.message);\n        });\n      }\n    },\n    leave: function leave() {\n      var _this13 = this;\n\n      // 离开房间，发起方挂断\n      this.isMicOn = true;\n      this.isCamOn = true;\n      this.maskShow = false;\n      this.isStartLocalView = false;\n\n      if (!this.calling) {\n        // 还没有通话，单方面挂断\n        this.trtcCalling.hangup().then(function (res) {\n          res.data.message.nick = _this13.currentUserProfile.nick;\n\n          _this13.$store.commit('pushCurrentMessageList', res.data.message);\n\n          _this13.changeState('dialling', false);\n\n          clearTimeout(_this13.timer);\n        });\n        return;\n      }\n\n      this.hangUp(); // 通话一段时间之后，某一方面结束通话\n    },\n    refuse: function refuse() {\n      // 拒绝电话\n      this.changeState('isDialled', false);\n      this.reject();\n    },\n    resetDuration: function resetDuration(duration) {\n      var _this14 = this;\n\n      this.duration = duration;\n      this.hangUpTimer = setTimeout(function () {\n        var now = new Date();\n\n        _this14.resetDuration(parseInt((now - _this14.start) / 1000));\n      }, 1000);\n    },\n    isAccept: function isAccept() {\n      // 对方接听自己发起的电话\n      clearTimeout(this.timer);\n      this.changeState('calling', true);\n      clearTimeout(this.hangUpTimer);\n      this.resetDuration(0);\n      this.start = new Date();\n    },\n    hangUp: function hangUp() {\n      // 通话一段时间之后，某一方挂断电话\n      this.changeState('calling', false);\n      this.trtcCalling.hangup();\n      this.$store.commit('showMessage', {\n        message: '已挂断'\n      });\n    },\n    videoHandler: function videoHandler() {\n      // 是否打开摄像头\n      if (this.isCamOn) {\n        this.isCamOn = false;\n        this.maskShow = true;\n        this.trtcCalling.closeCamera();\n      } else {\n        this.isCamOn = true;\n        this.maskShow = false;\n        this.trtcCalling.openCamera();\n      }\n    },\n    micHandler: function micHandler() {\n      // 是否打开麦克风\n      if (this.isMicOn) {\n        this.trtcCalling.setMicMute(true);\n        this.isMicOn = false;\n      } else {\n        this.trtcCalling.setMicMute(false);\n        this.isMicOn = true;\n      }\n    },\n    changeMainVideo: function changeMainVideo() {\n      if (!this.calling) {\n        return;\n      }\n\n      this.isLocalMain = !this.isLocalMain;\n    },\n    sendMessage: function () {\n      var _sendMessage = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2(userId, callEnd, callText) {\n        var call_text, messageData, message, customData, _customData;\n\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                call_text = '';\n                userId = Array.isArray(userId) ? userId.join(',') : userId;\n                messageData = {\n                  to: this.toAccount,\n                  from: userId,\n                  conversationType: this.currentConversationType,\n                  payload: {\n                    data: '',\n                    description: '',\n                    extension: ''\n                  }\n                };\n                _context2.next = 5;\n                return this.tim.createCustomMessage(messageData);\n\n              case 5:\n                message = _context2.sent;\n                _context2.t0 = callText;\n                _context2.next = _context2.t0 === this.callingTips.callEnd ? 9 : _context2.t0 === this.callingTips.callTimeout ? 16 : 18;\n                break;\n\n              case 9:\n                if (!(this.currentConversationType === this.TIM.TYPES.CONV_GROUP)) {\n                  _context2.next = 14;\n                  break;\n                }\n\n                call_text = '结束群聊';\n                return _context2.abrupt(\"break\", 20);\n\n              case 14:\n                call_text = callEnd === 0 ? '取消通话' : \"\\u7ED3\\u675F\\u901A\\u8BDD\\uFF0C\\u901A\\u8BDD\\u65F6\\u957F\\uFF1A\".concat(formatDuration(callEnd || this.duration));\n                return _context2.abrupt(\"break\", 20);\n\n              case 16:\n                call_text = '无应答';\n                return _context2.abrupt(\"break\", 20);\n\n              case 18:\n                call_text = '';\n                return _context2.abrupt(\"break\", 20);\n\n              case 20:\n                if (this.currentConversationType === this.TIM.TYPES.CONV_GROUP) {\n                  message.groupID = this.toAccount;\n                  customData = {\n                    operationType: 256,\n                    text: call_text,\n                    userIDList: []\n                  };\n                  message.payload = customData;\n                }\n\n                if (this.currentConversationType === this.TIM.TYPES.CONV_C2C) {\n                  _customData = {\n                    text: call_text\n                  };\n                  message.payload = _customData;\n                }\n\n                if (this.currentConversationType === this.TIM.TYPES.CONV_GROUP) {\n                  message.type = this.TIM.TYPES.MSG_GRP_TIP;\n                }\n\n                message.callType = 'callingTips';\n                this.$store.commit('pushCurrentMessageList', message);\n\n              case 25:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function sendMessage(_x2, _x3, _x4) {\n        return _sendMessage.apply(this, arguments);\n      }\n\n      return sendMessage;\n    }()\n  }\n};",{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwEA;AACA;AACA;AACAA,mBADA;AAEAC,MAFA,kBAEA;AACA;AACAC,mBADA;AAEAC,iBAFA;AAEA;AACAC,qBAHA;AAIAC,mBAJA;AAKAC,mBALA;AAMAC,0BANA;AAOAC,qBAPA;AAQAC,uBARA;AAQA;AACAC,cATA;AAUAC,YAVA;AAWAC,iBAXA;AAYAC,oBAZA;AAYA;AACAC,kBAbA;AAcAC,qBAdA;AAcA;AACAC,oBAfA;AAeA;AACAC,sBAhBA;AAgBA;AACAC,kBAjBA;AAkBAC,oBAlBA;AAmBAC,iBAnBA;AAmBA;AACAC,uBApBA;AAoBA;AACAC,qBArBA;AAsBAC,yBAtBA;AAuBAC,8FAvBA;AAwBAC,wBAxBA;AAyBAC,yBAzBA;AAyBA;AACAC,wBA1BA;AA0BA;AACAC,6BA3BA;AA2BA;AACAC;AACAC,kBADA;AACA;AACAC;AAFA;AA5BA;AAiCA,GApCA;AAqCAC,0DACAC,oDADA,GAEAC;AACAC;AAAA;AAAA,KADA;AAEAC;AAAA;AAAA,KAFA;AAGAC;AAAA;AAAA,KAHA;AAIAC;AAAA;AAAA,KAJA;AAKAC;AAAA;AAAA,KALA;AAMAC;AAAA;AAAA,KANA;AAOAC;AAAA;AAAA;AAPA,IAFA;AAWAC,qBAXA,+BAWA;AACA;AACA,KAbA;AAeAC,YAfA,sBAeA;AACA;AACA,KAjBA;AAkBAC,UAlBA,oBAkBA;AAEA;AACA;AArBA,IArCA;AA4DAC,SA5DA,qBA4DA;AACA;AACA,GA9DA;AA+DAC;AACApB;AACAqB,aADA,mBACAC,QADA,EACA;AAAA;;AACA;AAAA;AACA;AACA;AACA;AACA;AACA,8EAJA,CAKA;AACA;;AACA;AACA;AACA;;AACA;AACA;AACA;;AACAC;AACAC;AACAC;AACA;AACA;AACA,WAlBA;AAmBA;AACA;;AACA;AACA;AACAA;AACA;AACAC;AACA;AACAC;AACA;;AACAA;AACAA;AACA,WANA;AAOA;AACA,OApCA;AAqCAC,gBArCA;AAsCAC;AAtCA;AADA,GA/DA;AAyGAC,WAzGA,uBAyGA;AAAA;;AACA;AACAC;AACA;AACA,KAFA;AAGAA;AACA;AACA,KAFA;AAGA,GAjHA;AAkHAC,SAlHA,qBAkHA;AACA,mDADA,CACA;;AACA,mDAFA,CAEA;AAEA,GAtHA;AAuHAC,eAvHA,2BAuHA;AACA;AACA,oDAFA,CAEA;AAEA,GA3HA;AA4HAC;AACAC,mBADA,6BACA;AAAA;AACA;AACA;AACA;;AACA;AACA;AACA;AACA,KARA;AASAC,gBATA,0BASA;AACA;AACA,0EAFA,CAGA;;AACA,4FAJA,CAKA;;AACA,mFANA,CAOA;;AACA,mFARA,CASA;;AACA,mFAVA,CAWA;;AACA,wFAZA,CAaA;;AACA,2FAdA,CAeA;;AACA,mFAhBA,CAiBA;;AACA,0FAlBA,CAmBA;;AACA,iFApBA,CAqBA;;AACA,kFAtBA,CAuBA;;AACA,mGAxBA,CAyBA;;AACA;AACA,KApCA;AAqCAC,kBArCA,4BAqCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAnDA;AAqDAC,eArDA,yBAqDA,EArDA;AAsDA;AACAC,+BAvDA;AAAA,kHAuDAC,OAvDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAwDAhD,wBAxDA,GAwDAgD,OAxDA,CAwDAhD,QAxDA,EAwDAE,OAxDA,GAwDA8C,OAxDA,CAwDA9C,OAxDA,EAwDAD,UAxDA,GAwDA+C,OAxDA,CAwDA/C,UAxDA,EAwDAgD,UAxDA,GAwDAD,OAxDA,CAwDAC,UAxDA,EAwDAC,WAxDA,GAwDAF,OAxDA,CAwDAE,WAxDA;AAyDA;AACA;AACA;AACA;AACA,4EA7DA,CA6DA;;AACA;AACA;;AA/DA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAkEAC,UAlEA,oBAkEA;AAAA;;AACA;AACAnD,+BADA;AAEAoD,sCAFA;AAGAnE;AAHA,SAIAoE,IAJA,CAIA;AACA;AACA;;AACAC;;AACA;AACA,OATA;AAUA,KA7EA;AA8EAC,UA9EA,oBA8EA;AAAA;;AACA;AACA;AACAvD,+BADA;AAEAwD,qBAFA;AAGAvE;AAHA,SAIAoE,IAJA,CAIA;AACAC;;AACA;AACA,OAPA;AAQA,KAxFA;AAyFAG,kBAzFA,0BAyFAC,IAzFA,EAyFAC,IAzFA,EAyFA;AACA;AACA;AACA;AACA;AACAD;AACA,OAFA,EAEAC,IAFA;AAGA,KAhGA;AAiGA;AACAC,mBAlGA,iCAkGA;AAAA;;AAAA;AACA;AACA,sBAFA,CAGA;;AACA;AACA;AACA;;AACA;AACA;AACA;AACA,SAFA,MAEA;AACA;AACA;AACA;;AACA;AACA;AACA;AACA,oCADA,CACA;;AACA;;AACA,yCAJA,CAIA;;AACA,SALA;AAMA;AACA,KAxHA;AAyHA;AACAC,mBA1HA,kCA0HA;AAAA;;AACA;AACA;AACA;AAAA;AAAA;;AACA;AACA;AACA;;AACA;AACA;;AACA;AAAA;AAAA;;AACA;AACA;AACA;AACA,KAvIA;AAwIA;AACA;AACAC,uBA1IA,sCA0IA;AAAA;;AACA;AACA;AACA;AACA;AACAC;AADA;AAGA;AACA,KAlJA;AAmJAC,oBAnJA,4BAmJA5C,MAnJA,EAmJA;AACA;;AACA;AACA;AACA;;AACA;AACA;AACA;AACA;AACA,KA5JA;AA6JA;AACA6C,yBA9JA,wCA8JA;AAAA;AAAA;;AACA;AACA;AACA;AACA;AACAF;AADA;AAGA;AACA,KAtKA;AAuKA;AACAG,uBAxKA,iCAwKA;AACA;AACA;AACA;AACAH;AADA;AAGA,KA9KA;AAgLAI,mBAhLA,6BAgLA,CACA;AACA;AACA;AACA,KApLA;AAqLA;AACA;AACAC,qBAvLA,oCAuLA;AAAA;;AAAA;;AACA;AACA;AACA;;AACA;AAAA;AACAnB;AACA,0CADA,CACA;;AACA,SAFA;AAGA;AACA,OATA,CAUA;;;AACA;AAAA;AACA;AACA;AACA;;AACA;AACA,KAvMA;AAwMA;AACAoB,iBAzMA,gCAyMA;AAAA;AAAA;;AACA;AACA;AACA;AACA;AACA,OALA,CAMA;AACA;;;AACA;AACA;AACA;AACA;AACA,oCAZA,CAaA;AACA;AACA;AAEA,KA1NA;A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","names":["name","data","timeout","callType","Trtc","isCamOn","isMicOn","isInvitedMicOn","maskShow","isLocalMain","start","end","duration","hangUpTimer","ready","dialling","calling","isDialled","inviteID","inviteData","sponsor","invitedUserID","invitedNick","invitedUserInfo","defaultAvatar","viewLocalDomID","callingUserList","callingType","isStartLocalView","callingTips","callEnd","callTimeout","computed","mapGetters","mapState","currentConversation","currentUserProfile","callingInfo","userID","userSig","videoRoom","sdkAppID","formatDurationStr","myAvatar","myNick","created","watch","handler","newValue","element","local","group_element","elements","item","deep","immediate","destroyed","window","mounted","beforeDestroy","methods","videoCallLogOut","initListener","removeListener","handleError","handleNewInvitationReceived","payload","userIDList","isGroupCall","accept","roomID","then","res","reject","isBusy","handleDebounce","func","wait","handleUserEnter","handleUserLeave","handleInviteeReject","message","setCallingstatus","handleInviteeLineBusy","handleInviterCancel","handleKickedOut","handleCallTimeout","handleCallEnd","handleNoResponse","handleUserVideoChange","handleUserAudioChange","startLocalView","videoViewDomID","stopLocalView","startRemoteView","stopRemoteView","getUserAvatar","promise","catch","changeState","state","boolean","stateList","videoCalling","type","groupID","audioCalling","leave","clearTimeout","refuse","resetDuration","isAccept","hangUp","videoHandler","micHandler","changeMainVideo","sendMessage","userId","callText","call_text","messageData","to","from","conversationType","description","extension","customData","operationType","text"],"sourceRoot":"src/components/message/trtc-calling","sources":["calling-index.vue"],"sourcesContent":["<template>\r\n    <div class=\"call-container\" v-show=\"dialling || calling || isDialled\">\r\n        <div class=\"choose\" v-show=\"isDialled\">\r\n            <div class=\"title\">\r\n                {{ sponsor }}来通话啦\r\n            </div>\r\n            <div class=\"buttons\">\r\n                <div class=\"accept\" @click=\"handleDebounce(accept,500)\"></div>\r\n                <div class=\"refuse\" @click=\"handleDebounce(refuse,500)\"></div>\r\n            </div>\r\n        </div>\r\n        <div class=\"call\" v-show=\"dialling || calling\">\r\n            <div class=\"title\" v-if=\"dialling && currentConversationType==='C2C'\">\r\n                正在呼叫{{toAccount}}...\r\n            </div>\r\n            <div class=\"title\" v-if=\"dialling && currentConversationType==='GROUP'\">\r\n                正在呼叫...\r\n            </div>\r\n\r\n<!--            <div v-show=\"this.callingUserList.length < 2 && callType === TRTCCalling.CALL_TYPE.VIDEO_CALL && calling\">-->\r\n<!--                <div id=\"local\" @click=\"changeMainVideo\" :class=\"isLocalMain ? 'small' : 'big'\" ></div>-->\r\n<!--                <div v-for=\"userId in callingUserList\" :id=\"`video-${userId}`\" :key=\"`video-${userId}`\" :class=\"isLocalMain ? 'big' : 'small'\" @click=\"changeMainVideo\"></div>-->\r\n<!--            </div>-->\r\n            <div v-show=\" callType === TRTCCalling.CALL_TYPE.VIDEO_CALL && calling\">\r\n                <div class=\"small-group\"  id=\"small-group\">\r\n                    <div  class=\"video-box\"  id=\"local\" ></div>\r\n                    <div  class=\"video-box\" v-for=\"userId in callingUserList\" :id=\"`video-${userId}`\" :key=\"`video-${userId}`\">\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div v-show=\"callType === TRTCCalling.CALL_TYPE.AUDIO_CALL && calling\" class=\"audio-box\">\r\n                <div v-show=\"calling\" class=\"aduio-call\">\r\n                    <img :src=\"myAvatar\" class=\"audio-img\">\r\n                    <p style=\"text-align: center\">\r\n                        <span class=\"nick-text\">{{myNick}}</span>\r\n                        <i v-if=\"isMicOn\" class=\"el-icon-microphone micr-icon\" style=\"color: #006FFF;\"></i>\r\n                        <i  v-else  class=\"el-icon-turn-off-microphone micr-icon\" ></i>\r\n                    </p>\r\n                </div>\r\n                <div v-for=\"item in invitedUserInfo \" class=\"aduio-call\" :key=\"`video-${item.userID}`\" >\r\n                    <img :src=\"item.avatar || defaultAvatar\" class=\"audio-img\">\r\n                    <p style=\"text-align: center\">\r\n                        <span class=\"nick-text\">{{item.nick || item.userID}}</span>\r\n                        <i v-if=\"item.isInvitedMicOn === true || item.isInvitedMicOn == undefined\" class=\"el-icon-microphone micr-icon\" style=\"color: #006FFF;\"></i>\r\n                        <i  v-else  class=\"el-icon-turn-off-microphone micr-icon\" ></i>\r\n                    </p>\r\n                </div>\r\n            </div>\r\n            <div class=\"duration\" v-show=\"calling\">\r\n                {{ formatDurationStr }}\r\n            </div>\r\n            <div class=\"buttons\" v-if=\"callType === TRTCCalling.CALL_TYPE.VIDEO_CALL\">\r\n                <div :class=\"isCamOn ? 'videoOn' : 'videoOff'\" @click=\"videoHandler\"></div>\r\n                <div class=\"refuse\" @click=\"handleDebounce(leave,500)\"></div>\r\n                <div :class=\"isMicOn ? 'micOn' : 'micOff'\" @click=\"micHandler\"></div>\r\n            </div>\r\n            <div class=\"buttons\" v-else>\r\n<!--                <div :class=\"isCamOn ? 'videoOn' : 'videoOff'\" @click=\"videoHandler\"></div>-->\r\n                <div class=\"refuse\" @click=\"handleDebounce(leave,500)\"></div>\r\n                <div :class=\"isMicOn ? 'micOn' : 'micOff'\" @click=\"micHandler\"></div>\r\n            </div>\r\n<!--            <div class=\"mask\" v-show=\"maskShow\" :class=\"isLocalMain ? 'small' : 'big'\" @click=\"changeMainVideo\">-->\r\n<!--                <div>-->\r\n<!--                    <img class=\"image\" src=\"../../../assets/image/camera-max.png\"/>-->\r\n<!--                    <p class=\"notice\">摄像头未打开</p>-->\r\n<!--                </div>-->\r\n<!--            </div>-->\r\n        </div>\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n  import {mapGetters, mapState} from 'vuex'\r\n  import { formatDuration } from '../../../utils/formatDuration'\r\n  export default {\r\n    name: 'CallLayer',\r\n    data() {\r\n      return {\r\n        timeout:null,\r\n        callType:1,   //1:audio，2:video\r\n        Trtc: undefined,\r\n        isCamOn: true,\r\n        isMicOn: true,\r\n        isInvitedMicOn:true,\r\n        maskShow: false,\r\n        isLocalMain: true, // 本地视频是否是主屏幕显示\r\n        start: 0,\r\n        end: 0,\r\n        duration: 0,\r\n        hangUpTimer: 0, // 通话计时id\r\n        ready: false,\r\n        dialling: false, // 是否拨打电话中\r\n        calling: false, // 是否通话中\r\n        isDialled: false, // 是否被呼叫\r\n        inviteID:'',\r\n        inviteData:{},\r\n        sponsor:'',   //发起者\r\n        invitedUserID:[],  //被邀请者\r\n        invitedNick:'',\r\n        invitedUserInfo:[],\r\n        defaultAvatar:'https://imgcache.qq.com/open/qcloud/video/act/webim-avatar/avatar-3.png',\r\n        viewLocalDomID:'',\r\n        callingUserList:[],  // 参加通话的人 ,不包括自己\r\n        callingType:'C2C',  //区分多人和C2C通话的UI样式\r\n        isStartLocalView:false,  //本地是否开启\r\n        callingTips:{\r\n          callEnd:1,   //通话结束\r\n          callTimeout:5\r\n        }\r\n      }\r\n    },\r\n    computed: {\r\n      ...mapGetters(['toAccount', 'currentConversationType']),\r\n      ...mapState({\r\n        currentConversation: state => state.conversation.currentConversation,\r\n        currentUserProfile: state => state.user.currentUserProfile,\r\n        callingInfo: state => state.conversation.callingInfo,\r\n        userID: state => state.user.userID,\r\n        userSig: state => state.user.userSig,\r\n        videoRoom: state => state.video.videoRoom,\r\n        sdkAppID: state => state.user.sdkAppID\r\n      }),\r\n      formatDurationStr() {\r\n        return formatDuration(this.duration)\r\n      },\r\n\r\n      myAvatar() {\r\n          return this.currentUserProfile.avatar || this.defaultAvatar\r\n      },\r\n      myNick() {\r\n\r\n        return this.currentUserProfile.nick || this.userID\r\n      }\r\n    },\r\n    created() {\r\n      this.initListener()\r\n    },\r\n    watch: {\r\n      callingUserList: {\r\n        handler(newValue) {\r\n          if(newValue.length < 2 && this.calling) {   //单人通话\r\n            this.$nextTick(() => {\r\n              let elementId = `video-${newValue[0]}`\r\n              let element = window.document.getElementById(elementId)\r\n              let local = window.document.getElementById('local')\r\n              let group_element = window.document.getElementById('small-group')\r\n              // element.addEventListener('click', this.changeMainVideo)\r\n              // local.addEventListener('click', this.changeMainVideo)\r\n              if (!element || !element.classList) {\r\n                return\r\n              }\r\n              if (!local || !local.classList) {\r\n                return\r\n              }\r\n              element && element.classList.remove('video-box')\r\n              local && local.classList.remove('video-box')\r\n              group_element && group_element.classList.add('small-group_box')\r\n              this.isLocalMain ? element.classList.add('big') : element.classList.add('small')\r\n              this.isLocalMain ? local.classList.add('small') : element.classList.add('big')\r\n            })\r\n            return\r\n          }\r\n          if (newValue.length >= 2 && this.calling) {\r\n            let group_element = window.document.getElementById('small-group')\r\n            group_element && group_element.classList.remove('small-group_box')\r\n            let elements = window.document.getElementById('small-group').childNodes\r\n              elements.forEach((item,index) => {\r\n                if(index === 0) {\r\n                  item.classList.remove('small')\r\n                }\r\n                item.classList.remove('big')\r\n                item.classList.add('video-box')\r\n              })\r\n          }\r\n        },\r\n        deep: true,\r\n        immediate: true\r\n      }\r\n    },\r\n    destroyed() {\r\n      this.removeListener()\r\n      window.addEventListener('beforeunload', () => {\r\n        this.videoCallLogOut()\r\n      })\r\n      window.addEventListener('leave', () => {\r\n        this.videoCallLogOut()\r\n      })\r\n    },\r\n    mounted() {\r\n      this.$bus.$on('video-call', this.videoCalling)  // 发起通话\r\n      this.$bus.$on('audio-call', this.audioCalling)  // 发起通话\r\n\r\n    },\r\n    beforeDestroy() {\r\n      this.$bus.$off('video-call', this.videoCalling)\r\n      this.$bus.$off('audio-call', this.audioCalling)  // 发起通话\r\n\r\n    },\r\n    methods: {\r\n      videoCallLogOut() { // 针对，刷新页面，关闭Tab，登出情况下，通话断开的逻辑\r\n        if (this.dialling || this.calling) {\r\n          this.leave()\r\n        }\r\n        if (this.isDialled) {\r\n          this.refuse()\r\n        }\r\n      },\r\n      initListener() {\r\n        // sdk内部发生了错误\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.ERROR, this.handleError)\r\n        // 被邀请进行通话\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.INVITED, this.handleNewInvitationReceived)\r\n        // 有用户同意进入通话，那么会收到此回调\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.USER_ENTER, this.handleUserEnter)\r\n        // 如果有用户同意离开通话，那么会收到此回调\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.USER_LEAVE, this.handleUserLeave)\r\n        // 用户拒绝通话\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.REJECT, this.handleInviteeReject)\r\n        //邀请方忙线\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.LINE_BUSY, this.handleInviteeLineBusy)\r\n        // 作为被邀请方会收到，收到该回调说明本次通话被取消了\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.CALLING_CANCEL, this.handleInviterCancel)\r\n        // 重复登陆，收到该回调说明被踢出房间\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.KICKED_OUT, this.handleKickedOut)\r\n        // 作为邀请方会收到，收到该回调说明本次通话超时未应答\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.CALLING_TIMEOUT, this.handleCallTimeout)\r\n        // 邀请用户无应答\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.NO_RESP, this.handleNoResponse)\r\n        // 收到该回调说明本次通话结束了\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.CALLING_END, this.handleCallEnd)\r\n        // 远端用户开启/关闭了摄像头, 会收到该回调\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.USER_VIDEO_AVAILABLE, this.handleUserVideoChange)\r\n        // 远端用户开启/关闭了麦克风, 会收到该回调\r\n        this.trtcCalling.on(this.TRTCCalling.EVENT.USER_AUDIO_AVAILABLE, this.handleUserAudioChange)\r\n      },\r\n      removeListener() {\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.ERROR, this.handleError)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.INVITED, this.handleNewInvitationReceived)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.USER_ENTER, this.handleUserEnter)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.USER_LEAVE, this.handleUserLeave)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.REJECT, this.handleInviteeReject)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.LINE_BUSY, this.handleInviteeLineBusy)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.CALLING_CANCEL, this.handleInviterCancel)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.KICKED_OUT, this.handleKickedOut)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.CALLING_TIMEOUT, this.handleCallTimeout)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.NO_RESP, this.handleNoResponse)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.CALLING_END, this.handleCallEnd)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.USER_VIDEO_AVAILABLE, this.handleUserVideoChange)\r\n        this.trtcCalling.off(this.TRTCCalling.EVENT.USER_AUDIO_AVAILABLE, this.handleUserAudioChange)\r\n      },\r\n\r\n      handleError() {},\r\n      // 被呼叫  接听方\r\n      async handleNewInvitationReceived (payload) {\r\n        const { inviteID, sponsor, inviteData, userIDList, isGroupCall } = payload\r\n        this.inviteID = inviteID\r\n        this.inviteData = inviteData\r\n        this.callType = inviteData.callType\r\n        this.sponsor = sponsor\r\n        this.invitedUserID = JSON.parse(JSON.stringify(userIDList))//被邀请者\r\n        this.callingInfo.type = isGroupCall ? this.TIM.TYPES.CONV_GROUP : this.TIM.TYPES.CONV_C2C\r\n        this.changeState('isDialled', true)\r\n      },\r\n\r\n      accept() {\r\n        this.trtcCalling.accept({\r\n          inviteID: this.inviteID,\r\n          roomID: this.inviteData.roomID,\r\n          callType: this.inviteData.callType\r\n        }).then((res) => {\r\n          // this.callType = this.inviteData.callType\r\n          this.changeState('calling', true)\r\n          res.data.message.nick = this.currentUserProfile.nick\r\n          this.$store.commit('pushCurrentMessageList', res.data.message)\r\n        })\r\n      },\r\n      reject() {\r\n        const { callType } = this.inviteData\r\n        this.trtcCalling.reject({\r\n          inviteID: this.inviteID,\r\n          isBusy: false,\r\n          callType\r\n        }).then((res) =>{\r\n          res.data.message.nick = this.currentUserProfile.nick\r\n          this.$store.commit('pushCurrentMessageList', res.data.message)\r\n        })\r\n      },\r\n      handleDebounce (func, wait) {\r\n        let context = this\r\n        let args = arguments\r\n        if (this.timeout) clearTimeout(this.timeout)\r\n        this.timeout = setTimeout(() => {\r\n          func.apply(context, args)\r\n        }, wait)\r\n      },\r\n      // 双方建立连接\r\n      handleUserEnter({ userID }) {\r\n        this.changeState('dialling', true)\r\n        this.isAccept()\r\n        // 判断是否为多人通话\r\n        if (this.callingUserList.length >= 2) {\r\n          this.callingType = this.TIM.TYPES.CONV_GROUP\r\n        }\r\n        if (this.callingUserList.indexOf(userID) === -1) {\r\n          if (this.callType === this.TRTCCalling.CALL_TYPE.AUDIO_CALL ) {\r\n            this.getUserAvatar(userID)\r\n          } else {\r\n            this.callingUserList.push(userID)\r\n          }\r\n        }\r\n        if (this.callType === this.TRTCCalling.CALL_TYPE.VIDEO_CALL ) {\r\n          this.$nextTick(() => {\r\n            if (!this.isStartLocalView) {\r\n              this.startLocalView()    //本地只开启一次\r\n            }\r\n            this.startRemoteView(userID)   //远端多次拉流\r\n          })\r\n        }\r\n      },\r\n      // 通话已建立\r\n      handleUserLeave({ userID }) {\r\n        if( this.callType === this.TRTCCalling.CALL_TYPE.AUDIO_CALL ) {\r\n          // 语音通话\r\n          const _index = this.invitedUserInfo.findIndex(item => item.userID === userID)\r\n          if (_index >= 0) {\r\n            this.invitedUserInfo.splice(_index, 1)\r\n          }\r\n          return\r\n        }\r\n        const index = this.callingUserList.findIndex(item => item === userID)\r\n        if (index >= 0) {\r\n          this.callingUserList.splice(index, 1)\r\n        }\r\n      },\r\n      // 通知呼叫方，未接通\r\n      //userID:invitee(被邀请者）\r\n      handleInviteeReject({ userID }) {\r\n          if (this.userID === this.sponsor) {\r\n              // 发起者\r\n              this.setCallingstatus(userID)\r\n              this.$store.commit('showMessage', {\r\n                  message: `${userID}拒绝通话`\r\n              })\r\n          }\r\n      },\r\n      setCallingstatus(userID) {\r\n        const _index = this.invitedUserID.indexOf(userID)\r\n        if (_index >= 0) {\r\n          this.invitedUserID.splice(_index, 1)\r\n        }\r\n        if ( this.invitedUserID.length ===0 ) {\r\n          this.changeState('isDialled', false)\r\n          this.changeState('dialling', false)\r\n        }\r\n      },\r\n      // 通知呼叫方，对方在忙碌，未接通\r\n      handleInviteeLineBusy({ sponsor, userID }) {\r\n        // A call B,C call A, A在忙线， 拒绝通话，对于呼叫者C收到通知，XXX在忙线\r\n        if( sponsor === this.userID ) {\r\n          this.setCallingstatus(userID)\r\n          this.$store.commit('showMessage', {\r\n            message: `${userID}忙线`\r\n          })\r\n        }\r\n      },\r\n      // 通知被呼叫方，邀请被取消，未接通\r\n      handleInviterCancel() {\r\n        // 邀请被取消\r\n        this.changeState('isDialled', false)\r\n        this.$store.commit('showMessage', {\r\n          message: '通话已取消'\r\n        })\r\n      },\r\n\r\n      handleKickedOut() {\r\n        // //重复登陆，被踢出房间\r\n        // this.trtcCalling.logout();\r\n        // this.$store.commit(\"userLogoutSuccess\");\r\n      },\r\n      // 当自己收到对端超时的信令时，或者当我是被邀请者但自己超时了，通知上层通话超时\r\n      // case: A呼叫B，B在线，B超时未响应，B会触发该事件，A也会触发该事件\r\n      handleCallTimeout({ userIDList }) {\r\n        if(this.calling) {\r\n          return\r\n        }\r\n        if (this.userID === this.sponsor) {   // 该用户是邀请者\r\n          userIDList.forEach((userID) =>{\r\n            this.setCallingstatus(userID)    //超时未接听\r\n          })\r\n          return\r\n        }\r\n         //用户是被邀请者\r\n        if(userIDList.indexOf(this.userID) > -1) {   //当超时者是自己时，添加消息\r\n          //会话列表切换后发消息\r\n          this.toAccount && this.sendMessage(this.userID,'',this.callingTips.callTimeout)\r\n        }\r\n        this.changeState('isDialled', false)\r\n      },\r\n      // 双方，通话已建立, 通话结束\r\n      handleCallEnd({userID, callEnd}) {\r\n         // 自己挂断的要补充消息  被邀请者都无应答时结束\r\n         // 历史消息中没有通话结束\r\n        if(userID === this.userID && this.invitedUserID.length === 0 || this.callingUserList === 0) {\r\n          this.sendMessage(userID,callEnd,this.callingTips.callEnd)\r\n        }\r\n        //   this.changeState('isDialled', false)\r\n        //   this.changeState('calling', false)\r\n          this.changeState('dialling', false)\r\n          this.isMicOn = true\r\n          this.isCamOn = true\r\n          this.maskShow = false\r\n          this.isStartLocalView = false\r\n          // this.$store.commit('showMessage', {\r\n          //   message: '通话已结束'\r\n          // })\r\n\r\n      },\r\n      // 自己超时且是邀请发起者，需主动挂断，并通知上层对端无应答\r\n      handleNoResponse({ sponsor, userIDList }) {  //邀请者\r\n        if(sponsor === this.userID) {\r\n          userIDList.forEach((userID) =>{\r\n            this.setCallingstatus(userID)\r\n          })\r\n          if(userIDList.indexOf(this.userID) === -1) {   //当超时者是自己时，添加消息\r\n            this.sendMessage(userIDList,'',this.callingTips.callTimeout)\r\n          }\r\n        }\r\n\r\n      },\r\n      handleUserVideoChange() {\r\n\r\n      },\r\n\r\n      handleUserAudioChange(payload) {\r\n        const _index = this.invitedUserInfo.findIndex(item => item.userID === payload.userID)\r\n        if (_index >= 0) {\r\n          this.invitedUserInfo[_index].isInvitedMicOn = payload.isAudioAvailable\r\n        }\r\n        // this.isInvitedMicOn = payload.isAudioAvailable\r\n      },\r\n\r\n      // 播放本地流\r\n      startLocalView() {\r\n        this.trtcCalling.startLocalView({\r\n          userID: this.userID,\r\n          videoViewDomID: 'local'\r\n        }).then(()=>{\r\n          this.isStartLocalView = true\r\n        })\r\n      },\r\n\r\n      // 没有用到\r\n      stopLocalView() {\r\n        this.trtcCalling.stopLocalView({\r\n          userID: this.userID,\r\n          videoViewDomID: this.viewLocalDomID\r\n        })\r\n      },\r\n      // 播放远端流\r\n      startRemoteView(userID) {\r\n        this.trtcCalling.startRemoteView({\r\n          userID: userID,\r\n          videoViewDomID: `video-${userID}`\r\n        }).then(()=>{\r\n\r\n        })\r\n      },\r\n      //没有用到\r\n      stopRemoteView(userID) {\r\n        this.trtcCalling.stopRemoteView({\r\n          userID: this.userID,\r\n          videoViewDomID: `video-${userID}`\r\n        })\r\n      },\r\n      //获取被呼叫者信息\r\n      getUserAvatar(userID) {\r\n        const _index = this.invitedUserInfo.findIndex(item => item.userID === userID)\r\n        if (_index >= 0) {\r\n          return\r\n        }\r\n        let _userIDList = [userID]\r\n        let promise = this.tim.getUserProfile({\r\n          userIDList:_userIDList  // 请注意：即使只拉取一个用户的资料，也需要用数组类型，例如：userIDList: ['user1']\r\n        })\r\n        promise.then((imResponse)=> {\r\n          if (imResponse.data[0]) {\r\n            this.invitedUserInfo.push(imResponse.data[0])\r\n          }\r\n        }).catch(()=> {\r\n        })\r\n      },\r\n      changeState(state, boolean) {\r\n        let stateList = ['dialling', 'isDialled', 'calling']\r\n        stateList.forEach(item => {\r\n          this[item] = item === state ? boolean : false\r\n        })\r\n        this.$store.commit('UPDATE_ISBUSY', stateList.some(item => this[item])) // 若stateList 中存在 true , isBusy 为 true\r\n      },\r\n      videoCalling() { // 发起通话\r\n        // 初始化被邀请者\r\n        this.invitedUserID =JSON.parse(JSON.stringify(this.callingInfo.memberList))\r\n        this.sponsor = this.userID\r\n        if (this.calling) { // 避免通话按钮多次快速的点击\r\n          return\r\n        }\r\n        this.callType = this.TRTCCalling.CALL_TYPE.VIDEO_CALL\r\n        this.isLocalMain = true\r\n        // 可设置超时\r\n        if(this.callingInfo.type === this.TIM.TYPES.CONV_C2C) {\r\n          this.trtcCalling.call({\r\n            userID: this.callingInfo.memberList[0],\r\n            type: this.callType,\r\n            timeout: 30\r\n          }).then((res)=>{\r\n            res.data.message.nick = this.currentUserProfile.nick\r\n            this.$store.commit('pushCurrentMessageList', res.data.message)\r\n            this.changeState('dialling', true)\r\n          })\r\n        } else {\r\n            this.trtcCalling.groupCall({\r\n            userIDList: this.callingInfo.memberList,\r\n            type: this.callType,\r\n            groupID: this.currentConversation.groupProfile.groupID,\r\n            timeout: 30\r\n          }).then((res)=>{\r\n            res.data.message.nick = this.currentUserProfile.nick\r\n            this.$store.commit('pushCurrentMessageList', res.data.message)\r\n            this.changeState('dialling', true)\r\n          })\r\n        }\r\n\r\n\r\n      },\r\n      audioCalling() { // 发起通话\r\n        // 初始化被邀请者\r\n        this.invitedUserID = this.callingInfo.memberList\r\n          this.sponsor = this.userID\r\n        if (this.calling) { // 避免通话按钮多次快速的点击\r\n          return\r\n        }\r\n        // // 发起者获取被邀约人信息\r\n        // this.getUserAvatar()\r\n        // 可设置超时\r\n        this.callType = this.TRTCCalling.CALL_TYPE.AUDIO_CALL\r\n        if(this.callingInfo.type === 'C2C') {\r\n          this.trtcCalling.call({\r\n            userID: this.callingInfo.memberList[0],\r\n            type: this.callType,\r\n            timeout: 30\r\n          }).then((res)=>{\r\n            this.changeState('dialling', true)\r\n            res.data.message.nick = this.currentUserProfile.nick\r\n            this.$store.commit('pushCurrentMessageList', res.data.message)\r\n\r\n          })\r\n        } else {\r\n          this.trtcCalling.groupCall({\r\n            userIDList: this.callingInfo.memberList,\r\n            type: this.callType,\r\n            groupID: this.currentConversation.groupProfile.groupID,\r\n            timeout: 30\r\n          }).then((res)=>{\r\n            this.changeState('dialling', true)\r\n            res.data.message.nick = this.currentUserProfile.nick\r\n            this.$store.commit('pushCurrentMessageList', res.data.message)\r\n          })\r\n        }\r\n      },\r\n      leave() { // 离开房间，发起方挂断\r\n        this.isMicOn = true\r\n        this.isCamOn = true\r\n        this.maskShow = false\r\n        this.isStartLocalView = false\r\n        if (!this.calling) { // 还没有通话，单方面挂断\r\n          this.trtcCalling.hangup().then((res) => {\r\n            res.data.message.nick = this.currentUserProfile.nick\r\n            this.$store.commit('pushCurrentMessageList', res.data.message)\r\n            this.changeState('dialling', false)\r\n            clearTimeout(this.timer)\r\n\r\n          })\r\n          return\r\n        }\r\n        this.hangUp() // 通话一段时间之后，某一方面结束通话\r\n      },\r\n\r\n      refuse() { // 拒绝电话\r\n        this.changeState('isDialled', false)\r\n        this.reject()\r\n      },\r\n      resetDuration(duration) {\r\n        this.duration = duration\r\n        this.hangUpTimer = setTimeout(() => {\r\n          let now = new Date()\r\n          this.resetDuration(parseInt((now - this.start) / 1000))\r\n        }, 1000)\r\n      },\r\n\r\n      isAccept() { // 对方接听自己发起的电话\r\n        clearTimeout(this.timer)\r\n        this.changeState('calling', true)\r\n        clearTimeout(this.hangUpTimer)\r\n        this.resetDuration(0)\r\n        this.start = new Date()\r\n      },\r\n      hangUp() { // 通话一段时间之后，某一方挂断电话\r\n        this.changeState('calling', false)\r\n        this.trtcCalling.hangup()\r\n        this.$store.commit('showMessage', {\r\n          message: '已挂断'\r\n        })\r\n      },\r\n      videoHandler() { // 是否打开摄像头\r\n        if (this.isCamOn) {\r\n          this.isCamOn = false\r\n          this.maskShow = true\r\n          this.trtcCalling.closeCamera()\r\n        } else {\r\n          this.isCamOn = true\r\n          this.maskShow = false\r\n          this.trtcCalling.openCamera()\r\n        }\r\n      },\r\n      micHandler() { // 是否打开麦克风\r\n        if (this.isMicOn) {\r\n          this.trtcCalling.setMicMute(true)\r\n          this.isMicOn = false\r\n        } else {\r\n          this.trtcCalling.setMicMute(false)\r\n          this.isMicOn = true\r\n        }\r\n      },\r\n      changeMainVideo() {\r\n        if (!this.calling) {\r\n          return\r\n        }\r\n        this.isLocalMain = !this.isLocalMain\r\n      },\r\n     async sendMessage(userId,callEnd,callText) {\r\n        let call_text= ''\r\n       userId = Array.isArray(userId) ? userId.join(',') : userId\r\n        let messageData = {\r\n          to: this.toAccount,\r\n          from:userId,\r\n          conversationType: this.currentConversationType,\r\n          payload: {\r\n            data: '',\r\n            description: '',\r\n            extension: ''\r\n          }\r\n        }\r\n\r\n        const message = await this.tim.createCustomMessage(messageData)\r\n        switch (callText) {\r\n          case this.callingTips.callEnd:\r\n            if (this.currentConversationType === this.TIM.TYPES.CONV_GROUP) {\r\n              call_text = '结束群聊'\r\n              break\r\n            } else {\r\n              call_text = callEnd === 0 ?'取消通话' : `结束通话，通话时长：${formatDuration(callEnd || this.duration)}`\r\n              break\r\n            }\r\n          case this.callingTips.callTimeout:\r\n            call_text = '无应答'\r\n            break\r\n          default:\r\n            call_text = ''\r\n            break\r\n        }\r\n        if (this.currentConversationType === this.TIM.TYPES.CONV_GROUP) {\r\n          message.groupID = this.toAccount\r\n          let customData = {\r\n            operationType:256,\r\n            text:call_text,\r\n            userIDList:[]\r\n          }\r\n          message.payload = customData\r\n\r\n        }\r\n        if (this.currentConversationType === this.TIM.TYPES.CONV_C2C) {\r\n          let customData = {\r\n            text:call_text\r\n          }\r\n          message.payload = customData\r\n\r\n        }\r\n        if (this.currentConversationType === this.TIM.TYPES.CONV_GROUP) {\r\n          message.type = this.TIM.TYPES.MSG_GRP_TIP\r\n        }\r\n        message.callType = 'callingTips'\r\n        this.$store.commit('pushCurrentMessageList', message)\r\n      },\r\n    }\r\n  }\r\n</script>\r\n\r\n<style lang=\"stylus\" scoped>\r\n    .call-container\r\n        background center url(\"data:image/png;base64,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\")\r\n        background-size cover\r\n        position absolute\r\n        z-index 999\r\n\r\n    .accept, .refuse, .videoOn, .videoOff, .micOn, .micOff\r\n        height 50px\r\n        width 50px\r\n        box-sizing border-box\r\n        border-radius 50%\r\n        cursor: pointer\r\n\r\n    .accept\r\n        background center no-repeat url(\"../../../assets/image/call.png\")\r\n        background-size 60%\r\n        background-color $success\r\n\r\n    .refuse\r\n        background center no-repeat url(\"../../../assets/image/hangup.png\")\r\n        background-size 70%\r\n        background-color $danger\r\n\r\n    .videoOn\r\n        background center no-repeat url(\"../../../assets/image/big-camera-on.png\")\r\n\r\n    .videoOff\r\n        background center no-repeat url(\"../../../assets/image/big-camera-off.png\")\r\n\r\n    .micOn\r\n        background center no-repeat url(\"../../../assets/image/big-mic-on.png\")\r\n\r\n    .micOff\r\n        background center no-repeat url(\"../../../assets/image/big-mic-off.png\")\r\n\r\n    .buttons\r\n        position absolute\r\n        z-index 20\r\n        width 70%\r\n        top 75%\r\n        display flex\r\n        justify-content space-around\r\n        margin 0 15% 0 15%\r\n    .audio-box\r\n        position absolute\r\n        z-index 20\r\n        width 70%\r\n        top 200px\r\n        display flex\r\n        justify-content center\r\n        margin 0 15% 0 15%\r\n    .aduio-call\r\n        box-sizing border-box\r\n        width 140px\r\n        height 100px\r\n    .audio-img\r\n        display block\r\n        width 60px\r\n        height 60px\r\n        border-radius 50%\r\n        margin 0 auto 13px\r\n    .micr-icon\r\n        cursor pointer\r\n        font-size 28px\r\n        /*display block*/\r\n        /*text-align center*/\r\n    .nick-text\r\n        color #dddddd\r\n        font-size 12px\r\n        margin-right 5px\r\n        vertical-align super\r\n\r\n    .duration\r\n        color #fff\r\n        position absolute\r\n        z-index 20\r\n        width 100%\r\n        top 70%\r\n        display flex\r\n        justify-content center\r\n\r\n    .mask\r\n        position absolute\r\n        z-index 10\r\n        background #D8D8D8\r\n        height 100%\r\n        width 100%\r\n        display flex\r\n        align-items center\r\n        justify-content center\r\n\r\n        space\r\n        .image\r\n            margin-left 15%\r\n\r\n        .notice\r\n            color #888888\r\n\r\n    .choose, .call\r\n        color #fff\r\n        background-color rgba(0, 0, 0, 0.8)\r\n        height 100%\r\n        width 100%\r\n\r\n    .title\r\n        margin 25% 0 0 0\r\n        text-align center\r\n        width 100%\r\n        position absolute\r\n        z-index 10\r\n        color #fff\r\n        font-size 40px\r\n        font-weight 700\r\n\r\n    .big\r\n        position absolute\r\n        height 100%\r\n        width 100%\r\n\r\n    .small\r\n        position absolute\r\n        margin-left 74.8%\r\n        z-index 999\r\n        border-style solid\r\n        border-width 1px\r\n        border-color #808080\r\n        height 44.8%\r\n        width 25.2%\r\n    .big-group\r\n        height 60vh\r\n        width 100%\r\n\r\n    .small-group\r\n        display flex\r\n        flex-wrap wrap\r\n        position absolute\r\n        /*z-index 999*/\r\n        /*border-style solid*/\r\n        /*border-width 1px*/\r\n        /*border-color #808080*/\r\n        /*height 30%*/\r\n        width 100%\r\n        /*height 100%*/\r\n    .small-group_box {\r\n        height 100%\r\n    }\r\n    .video-box\r\n       width 33.3%\r\n       height 25vh\r\n\r\n\r\n</style>\r\n"]}]}