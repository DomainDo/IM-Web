{"remainingRequest":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\message\\merger-message\\mergerMessage-item.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\message\\merger-message\\mergerMessage-item.vue","mtime":1649851412191},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\babel-loader\\lib\\index.js","mtime":1649851455045},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js","mtime":1649851455309}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { mapState } from 'vuex'\nimport { decodeText } from '../../../utils/decodeText'\nimport { getFullDate } from '../../../utils/date'\nimport { Rate } from 'element-ui'\n\nexport default {\n  name: 'MessageItem',\n  props: {\n    message: {\n      type: Object,\n      required: true\n    },\n    payload: {\n      type: Object,\n      required: true\n    },\n\n  },\n  components: {\n    ElRate: Rate,\n  },\n  data() {\n    return {\n      renderDom: [],\n      showConversationList: false,\n      relayMessage: {},\n      selectedConversation: [],\n      messageSelected:[],\n    }\n  },\n  computed: {\n    ...mapState({\n      currentConversation: state => state.conversation.currentConversation,\n      currentUserProfile: state => state.user.currentUserProfile,\n      isShowConversationList: state => state.conversation.isShowConversationList,\n\n    }),\n    // 自定义消息\n    rate() {\n      return parseInt(this.payload.description)\n    },\n    // 图片消息\n    imageUrl() {\n      const url = this.payload.imageInfoArray[0].imageUrl\n      if (typeof url !== 'string') {\n        return ''\n      }\n      return url.slice(0, 2) === '//' ? `https:${url}` : url\n    },\n    // showProgressBar() {\n    //   return this.$parent.message.status === 'unSend'\n    // },\n    percentage() {\n      return Math.floor((this.$parent.message.progress || 0) * 100)\n    },\n    // 表情消息\n    faceUrl() {\n      let name = ''\n      if (this.payload.data.indexOf('@2x') > 0) {\n        name = this.payload.data\n      } else {\n        name = this.payload.data + '@2x'\n      }\n      return `https://web.sdk.qcloud.com/im/assets/face-elem/${name}.png`\n    },\n    // 时间换算\n    date() {\n      return getFullDate(new Date(this.message.time * 1000))\n    },\n\n    // 文件消息大小\n    fileSize() {\n      const size = this.payload.fileSize\n      if (size > 1024) {\n        if (size / 1024 > 1024) {\n          return `${this.toFixed(size / 1024 / 1024)} Mb`\n        }\n        return `${this.toFixed(size / 1024)} Kb`\n      }\n      return `${this.toFixed(size)}B`\n    },\n    // 消息昵称\n    from() {\n      const isC2C = this.currentConversation.type === this.TIM.TYPES.CONV_C2C\n      // 自己发送的用昵称渲染\n      if (this.isMine) {\n        return  this.currentUserProfile.nick || this.currentUserProfile.userID\n      }\n      // 1. C2C 的消息体中还无 nick / avatar 字段，需从 conversation.userProfile 中获取\n      if (isC2C) {\n        return (\n          this.currentConversation.userProfile.nick ||\n          this.currentConversation.userProfile.userID\n        )\n      }\n      // 2. 群组消息，用消息体中的 nick 渲染。nameCard暂时支持不完善\n      return this.message.nameCard ||  this.message.nick || this.message.from\n    },\n    avatar() {\n      if (this.currentConversation.type === 'C2C') {\n        return this.isMine\n          ? this.currentUserProfile.avatar\n          : this.currentConversation.userProfile.avatar\n      } else if (this.currentConversation.type === 'GROUP') {\n        return this.isMine\n          ? this.currentUserProfile.avatar\n          : this.message.avatar\n      } else {\n        return ''\n      }\n    },\n    currentConversationType() {\n      return this.currentConversation.type\n    },\n    isMine() {\n      return this.message.flow === 'out'\n    },\n    contentList() {\n      return decodeText(this.payload)\n    },\n  },\n  methods: {\n    // 自定义消息解析\n    translateCustomMessage(payload) {\n      let videoPayload = {}\n      try{\n        videoPayload = JSON.parse(payload.data)\n      } catch(e) {\n        videoPayload = {}\n      }\n      if (payload.data === 'group_create') {\n        return `${payload.extension}`\n      }\n      if (videoPayload.roomId) {\n        videoPayload.roomId = videoPayload.roomId.toString()\n        videoPayload.isFromGroupLive = 1\n        return videoPayload\n      }\n      if(payload.text) {\n        return payload.text\n      }else{\n        return '[自定义消息]'\n      }\n    },\n    // 图片消息\n    onImageLoaded(event) {\n      this.$bus.$emit('image-loaded', event)\n    },\n    handlePreview() {\n      this.$bus.$emit('image-preview', {\n        url: this.payload.imageInfoArray[0].url,\n        flag: true\n      })\n    },\n    toFixed(number, precision = 2) {\n      return number.toFixed(precision)\n    },\n    showGroupMemberProfile(event) {\n      this.tim\n        .getGroupMemberProfile({\n          groupID: this.message.to,\n          userIDList: [this.message.from]\n        })\n        .then(({ data: { memberList } }) => {\n          if (memberList[0]) {\n            this.$bus.$emit('showMemberProfile', { event, member: memberList[0] })\n          }\n        })\n    },\n    messageClick(message) {\n      this.$store.commit('showConversationList', false)\n      this.showConversationList = true\n      this.relayMessage = message   // 需要深拷贝吗？\n    },\n    showMergerMessage() {\n      this.$bus.$emit('mergerMessage', true)\n    },\n    cancel() {\n      this.showConversationList = false\n    },\n    getList(value) {\n      this.selectedConversation = value\n    },\n    messageRelay() {\n      let type = ''\n      let toUserId = ''\n      this.selectedConversation.forEach((item) => {\n        if(item.indexOf(this.TIM.TYPES.CONV_C2C) !== -1) {\n          type = this.TIM.TYPES.CONV_C2C\n          toUserId = item.substring(3,item.length)\n        }\n        if(item.indexOf(this.TIM.TYPES.CONV_GROUP) !== -1) {\n          type = this.TIM.TYPES.CONV_GROUP\n          toUserId = item.substring(5,item.length)\n        }\n        const message = this.tim.createForwardMessage({\n          to: toUserId,\n          conversationType: type,\n          payload: this.relayMessage,\n          priority: this.TIM.TYPES.MSG_PRIORITY_NORMAL\n        })\n        this.tim.sendMessage(message).catch(imError => {\n          this.$store.commit('showMessage', {\n            message: imError.message,\n            type: 'error'\n          })\n        })\n        this.showConversationList = false\n      })\n    },\n    // 合并的消息\n    mergerHandler(message) {\n      this.$store.commit('setMergerMessage', message)\n      // this.$bus.$emit('mergerMessage', message)\n    },\n    // 视频消息\n    videoError(e) {\n      this.$store.commit('showMessage', { type: 'error', message: '视频出错，错误原因：' + e.target.error.message })\n    },\n    // 音频消息\n    play() {\n      // 目前移动端的语音消息采用 aac 格式，以前用 amr 格式。默认先用 audio 标签播放，若无法播放则尝试 amr 格式播放。\n      const audio = document.createElement('audio')\n      audio.addEventListener('error', this.tryPlayAMR) // 播放出错，则尝试使用 AMR 播放\n      audio.src = this.payload.url\n      const promise = audio.play()\n      if (promise) {\n        promise.catch(() => {})\n      }\n    },\n    tryPlayAMR() {\n      try {\n        const isIE = /MSIE|Trident|Edge/.test(window.navigator.userAgent)\n        // amr 播放组件库在 IE 不支持\n        if (isIE) {\n          this.$store.commit('showMessage', {\n            message: '您的浏览器不支持该格式的语音消息播放，请尝试更换浏览器，建议使用：谷歌浏览器',\n            type: 'warning'\n          })\n          return\n        }\n        // 动态插入 amr 播放组件库\n        if (!window.BenzAMRRecorder) {\n          const script = document.createElement('script')\n          script.addEventListener('load', this.playAMR)\n          script.src = './BenzAMRRecorder.js'\n          const firstScript = document.getElementsByTagName('script')[0]\n          firstScript.parentNode.insertBefore(script, firstScript)\n          return\n        }\n        this.playAMR()\n      } catch (error) {\n        this.$store.commit('showMessage', {\n          message: '您的浏览器不支持该格式的语音消息播放，请尝试更换浏览器，建议使用：谷歌浏览器',\n          type: 'warning'\n        })\n      }\n    },\n    playAMR() {\n      if (!this.amr && window.BenzAMRRecorder) {\n        this.amr = new window.BenzAMRRecorder()\n      }\n      if (this.amr.isInit()) {\n        this.amr.play()\n        return\n      }\n      this.amr.initWithUrl(this.url).then(() => {\n        this.amr.play()\n      })\n    },\n    // 文件消息\n    downloadFile() {\n      // 浏览器支持fetch则用blob下载，避免浏览器点击a标签，跳转到新页面预览的行为\n      if (window.fetch) {\n        fetch(this.payload.fileUrl)\n          .then(res => res.blob())\n          .then(blob => {\n            let a = document.createElement('a')\n            let url = window.URL.createObjectURL(blob)\n            a.href = url\n            a.download = this.payload.fileName\n            a.click()\n          })\n      } else {\n        let a = document.createElement('a')\n        a.href = this.payload.fileUrl\n        a.target = '_blank'\n        a.download = this.filename\n        a.click()\n      }\n    }\n  }\n}\n",{"version":3,"sources":["mergerMessage-item.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA+EA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"mergerMessage-item.vue","sourceRoot":"src/components/message/merger-message","sourcesContent":["<template>\r\n    <div class=\"message-wrapper col-2\">\r\n        <div class=\"content-wrapper\">\r\n<!--文本消息-->\r\n            <div class=\"message-container\" v-if=\"message.type === 'TIMTextElem'\">\r\n                <div class=\"text-message\" v-for=\"(item, index) in contentList\" :key=\"index\">\r\n                    <span  :key=\"index\" v-if=\"item.name === 'text'\">{{ item.text }}</span>\r\n                    <img v-else-if=\"item.name === 'img'\" :src=\"item.src\" width=\"20px\" height=\"20px\" :key=\"index\"/>\r\n                </div>\r\n            </div>\r\n<!--图片消息-->\r\n            <div class=\"message-container\" v-else-if=\"message.type === 'TIMImageElem'\">\r\n                <img class=\"image-element\" :src=\"payload.imageInfoArray[0].url\" @load=\"onImageLoaded\" @click=\"handlePreview()\" />\r\n            </div>\r\n<!--文件消息-->\r\n            <div class=\"message-container\" v-else-if=\"message.type === 'TIMFileElem'\">\r\n                <div class=\"file-element-wrapper\" title=\"单击下载\" @click=\"downloadFile\">\r\n                    <div class=\"file-box\">\r\n                        <i class=\"el-icon-document file-icon\"></i>\r\n                        <div class=\"file-element\">\r\n                            <span class=\"file-name\">{{ payload.fileName }}</span>\r\n                            <span class=\"file-size\">{{ fileSize }}</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n<!--表情消息-->\r\n\r\n            <div class=\"message-container\" v-else-if=\"message.type === 'TIMFaceElem'\">\r\n                <img :src=\"faceUrl\"/>\r\n            </div>\r\n<!--视频消息-->\r\n            <div class=\"message-container\" v-else-if=\"message.type === TIM.TYPES.MSG_VIDEO\">\r\n                <video\r\n                        :src=\"payload.videoUrl\"\r\n                        controls\r\n                        class=\"merger-video\"\r\n                        @error=\"videoError\"\r\n                ></video>\r\n            </div>\r\n<!--音频消息-->\r\n            <div class=\"sound-element-wrapper\"  v-else-if=\"message.type === TIM.TYPES.MSG_AUDIO\" title=\"单击播放\" @click=\"play\">\r\n                <i class=\"iconfont icon-voice\"></i>\r\n                {{ payload.second + '\"' }}\r\n            </div>\r\n <!--自定义消息-->\r\n            <div class=\"message-container\" v-else-if=\"message.type === 'TIMCustomElem'\">\r\n                <div class=\"custom-element-wrapper\">\r\n                    <div class=\"survey\"  v-if=\"this.payload.data === 'survey'\">\r\n                        <div class=\"title\">对IM DEMO的评分和建议</div>\r\n                        <el-rate\r\n                                v-model=\"rate\"\r\n                                disabled\r\n                                show-score\r\n                                text-color=\"#ff9900\"\r\n                                score-template=\"{value}\">\r\n                        </el-rate>\r\n                        <div class=\"suggestion\">{{this.payload.extension}}</div>\r\n                    </div>\r\n                    <span class=\"text\" title=\"您可以自行解析自定义消息\" v-else>\r\n                      <template >{{translateCustomMessage(this.payload)}}</template>\r\n                    </span>\r\n                </div>\r\n            </div>\r\n<!--合并的消息-->\r\n            <div class=\"message-container\"  @click=\"mergerHandler(message)\" v-else-if=\"message.type === TIM.TYPES.MSG_MERGER\">\r\n                <div class=\"merger-item\">\r\n                    <p class=\"merger-title\">{{payload.title}}</p>\r\n                    <p class=\"merger-text\" v-for=\"(item, index) in payload.abstractList\" :key=\"index\">\r\n                        {{item}}\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n  import { mapState } from 'vuex'\r\n  import { decodeText } from '../../../utils/decodeText'\r\n  import { getFullDate } from '../../../utils/date'\r\n  import { Rate } from 'element-ui'\r\n\r\n  export default {\r\n    name: 'MessageItem',\r\n    props: {\r\n      message: {\r\n        type: Object,\r\n        required: true\r\n      },\r\n      payload: {\r\n        type: Object,\r\n        required: true\r\n      },\r\n\r\n    },\r\n    components: {\r\n      ElRate: Rate,\r\n    },\r\n    data() {\r\n      return {\r\n        renderDom: [],\r\n        showConversationList: false,\r\n        relayMessage: {},\r\n        selectedConversation: [],\r\n        messageSelected:[],\r\n      }\r\n    },\r\n    computed: {\r\n      ...mapState({\r\n        currentConversation: state => state.conversation.currentConversation,\r\n        currentUserProfile: state => state.user.currentUserProfile,\r\n        isShowConversationList: state => state.conversation.isShowConversationList,\r\n\r\n      }),\r\n      // 自定义消息\r\n      rate() {\r\n        return parseInt(this.payload.description)\r\n      },\r\n      // 图片消息\r\n      imageUrl() {\r\n        const url = this.payload.imageInfoArray[0].imageUrl\r\n        if (typeof url !== 'string') {\r\n          return ''\r\n        }\r\n        return url.slice(0, 2) === '//' ? `https:${url}` : url\r\n      },\r\n      // showProgressBar() {\r\n      //   return this.$parent.message.status === 'unSend'\r\n      // },\r\n      percentage() {\r\n        return Math.floor((this.$parent.message.progress || 0) * 100)\r\n      },\r\n      // 表情消息\r\n      faceUrl() {\r\n        let name = ''\r\n        if (this.payload.data.indexOf('@2x') > 0) {\r\n          name = this.payload.data\r\n        } else {\r\n          name = this.payload.data + '@2x'\r\n        }\r\n        return `https://web.sdk.qcloud.com/im/assets/face-elem/${name}.png`\r\n      },\r\n      // 时间换算\r\n      date() {\r\n        return getFullDate(new Date(this.message.time * 1000))\r\n      },\r\n\r\n      // 文件消息大小\r\n      fileSize() {\r\n        const size = this.payload.fileSize\r\n        if (size > 1024) {\r\n          if (size / 1024 > 1024) {\r\n            return `${this.toFixed(size / 1024 / 1024)} Mb`\r\n          }\r\n          return `${this.toFixed(size / 1024)} Kb`\r\n        }\r\n        return `${this.toFixed(size)}B`\r\n      },\r\n      // 消息昵称\r\n      from() {\r\n        const isC2C = this.currentConversation.type === this.TIM.TYPES.CONV_C2C\r\n        // 自己发送的用昵称渲染\r\n        if (this.isMine) {\r\n          return  this.currentUserProfile.nick || this.currentUserProfile.userID\r\n        }\r\n        // 1. C2C 的消息体中还无 nick / avatar 字段，需从 conversation.userProfile 中获取\r\n        if (isC2C) {\r\n          return (\r\n            this.currentConversation.userProfile.nick ||\r\n            this.currentConversation.userProfile.userID\r\n          )\r\n        }\r\n        // 2. 群组消息，用消息体中的 nick 渲染。nameCard暂时支持不完善\r\n        return this.message.nameCard ||  this.message.nick || this.message.from\r\n      },\r\n      avatar() {\r\n        if (this.currentConversation.type === 'C2C') {\r\n          return this.isMine\r\n            ? this.currentUserProfile.avatar\r\n            : this.currentConversation.userProfile.avatar\r\n        } else if (this.currentConversation.type === 'GROUP') {\r\n          return this.isMine\r\n            ? this.currentUserProfile.avatar\r\n            : this.message.avatar\r\n        } else {\r\n          return ''\r\n        }\r\n      },\r\n      currentConversationType() {\r\n        return this.currentConversation.type\r\n      },\r\n      isMine() {\r\n        return this.message.flow === 'out'\r\n      },\r\n      contentList() {\r\n        return decodeText(this.payload)\r\n      },\r\n    },\r\n    methods: {\r\n      // 自定义消息解析\r\n      translateCustomMessage(payload) {\r\n        let videoPayload = {}\r\n        try{\r\n          videoPayload = JSON.parse(payload.data)\r\n        } catch(e) {\r\n          videoPayload = {}\r\n        }\r\n        if (payload.data === 'group_create') {\r\n          return `${payload.extension}`\r\n        }\r\n        if (videoPayload.roomId) {\r\n          videoPayload.roomId = videoPayload.roomId.toString()\r\n          videoPayload.isFromGroupLive = 1\r\n          return videoPayload\r\n        }\r\n        if(payload.text) {\r\n          return payload.text\r\n        }else{\r\n          return '[自定义消息]'\r\n        }\r\n      },\r\n      // 图片消息\r\n      onImageLoaded(event) {\r\n        this.$bus.$emit('image-loaded', event)\r\n      },\r\n      handlePreview() {\r\n        this.$bus.$emit('image-preview', {\r\n          url: this.payload.imageInfoArray[0].url,\r\n          flag: true\r\n        })\r\n      },\r\n      toFixed(number, precision = 2) {\r\n        return number.toFixed(precision)\r\n      },\r\n      showGroupMemberProfile(event) {\r\n        this.tim\r\n          .getGroupMemberProfile({\r\n            groupID: this.message.to,\r\n            userIDList: [this.message.from]\r\n          })\r\n          .then(({ data: { memberList } }) => {\r\n            if (memberList[0]) {\r\n              this.$bus.$emit('showMemberProfile', { event, member: memberList[0] })\r\n            }\r\n          })\r\n      },\r\n      messageClick(message) {\r\n        this.$store.commit('showConversationList', false)\r\n        this.showConversationList = true\r\n        this.relayMessage = message   // 需要深拷贝吗？\r\n      },\r\n      showMergerMessage() {\r\n        this.$bus.$emit('mergerMessage', true)\r\n      },\r\n      cancel() {\r\n        this.showConversationList = false\r\n      },\r\n      getList(value) {\r\n        this.selectedConversation = value\r\n      },\r\n      messageRelay() {\r\n        let type = ''\r\n        let toUserId = ''\r\n        this.selectedConversation.forEach((item) => {\r\n          if(item.indexOf(this.TIM.TYPES.CONV_C2C) !== -1) {\r\n            type = this.TIM.TYPES.CONV_C2C\r\n            toUserId = item.substring(3,item.length)\r\n          }\r\n          if(item.indexOf(this.TIM.TYPES.CONV_GROUP) !== -1) {\r\n            type = this.TIM.TYPES.CONV_GROUP\r\n            toUserId = item.substring(5,item.length)\r\n          }\r\n          const message = this.tim.createForwardMessage({\r\n            to: toUserId,\r\n            conversationType: type,\r\n            payload: this.relayMessage,\r\n            priority: this.TIM.TYPES.MSG_PRIORITY_NORMAL\r\n          })\r\n          this.tim.sendMessage(message).catch(imError => {\r\n            this.$store.commit('showMessage', {\r\n              message: imError.message,\r\n              type: 'error'\r\n            })\r\n          })\r\n          this.showConversationList = false\r\n        })\r\n      },\r\n      // 合并的消息\r\n      mergerHandler(message) {\r\n        this.$store.commit('setMergerMessage', message)\r\n        // this.$bus.$emit('mergerMessage', message)\r\n      },\r\n      // 视频消息\r\n      videoError(e) {\r\n        this.$store.commit('showMessage', { type: 'error', message: '视频出错，错误原因：' + e.target.error.message })\r\n      },\r\n      // 音频消息\r\n      play() {\r\n        // 目前移动端的语音消息采用 aac 格式，以前用 amr 格式。默认先用 audio 标签播放，若无法播放则尝试 amr 格式播放。\r\n        const audio = document.createElement('audio')\r\n        audio.addEventListener('error', this.tryPlayAMR) // 播放出错，则尝试使用 AMR 播放\r\n        audio.src = this.payload.url\r\n        const promise = audio.play()\r\n        if (promise) {\r\n          promise.catch(() => {})\r\n        }\r\n      },\r\n      tryPlayAMR() {\r\n        try {\r\n          const isIE = /MSIE|Trident|Edge/.test(window.navigator.userAgent)\r\n          // amr 播放组件库在 IE 不支持\r\n          if (isIE) {\r\n            this.$store.commit('showMessage', {\r\n              message: '您的浏览器不支持该格式的语音消息播放，请尝试更换浏览器，建议使用：谷歌浏览器',\r\n              type: 'warning'\r\n            })\r\n            return\r\n          }\r\n          // 动态插入 amr 播放组件库\r\n          if (!window.BenzAMRRecorder) {\r\n            const script = document.createElement('script')\r\n            script.addEventListener('load', this.playAMR)\r\n            script.src = './BenzAMRRecorder.js'\r\n            const firstScript = document.getElementsByTagName('script')[0]\r\n            firstScript.parentNode.insertBefore(script, firstScript)\r\n            return\r\n          }\r\n          this.playAMR()\r\n        } catch (error) {\r\n          this.$store.commit('showMessage', {\r\n            message: '您的浏览器不支持该格式的语音消息播放，请尝试更换浏览器，建议使用：谷歌浏览器',\r\n            type: 'warning'\r\n          })\r\n        }\r\n      },\r\n      playAMR() {\r\n        if (!this.amr && window.BenzAMRRecorder) {\r\n          this.amr = new window.BenzAMRRecorder()\r\n        }\r\n        if (this.amr.isInit()) {\r\n          this.amr.play()\r\n          return\r\n        }\r\n        this.amr.initWithUrl(this.url).then(() => {\r\n          this.amr.play()\r\n        })\r\n      },\r\n      // 文件消息\r\n      downloadFile() {\r\n        // 浏览器支持fetch则用blob下载，避免浏览器点击a标签，跳转到新页面预览的行为\r\n        if (window.fetch) {\r\n          fetch(this.payload.fileUrl)\r\n            .then(res => res.blob())\r\n            .then(blob => {\r\n              let a = document.createElement('a')\r\n              let url = window.URL.createObjectURL(blob)\r\n              a.href = url\r\n              a.download = this.payload.fileName\r\n              a.click()\r\n            })\r\n        } else {\r\n          let a = document.createElement('a')\r\n          a.href = this.payload.fileUrl\r\n          a.target = '_blank'\r\n          a.download = this.filename\r\n          a.click()\r\n        }\r\n      }\r\n    }\r\n  }\r\n</script>\r\n\r\n<style lang=\"stylus\" scoped>\r\n    .conversation-container {\r\n        position absolute\r\n        top 0\r\n        left 0px\r\n        width 100%\r\n        background-color #fff\r\n        z-index 999\r\n    }\r\n    .conversation-list-btn {\r\n        width 140px\r\n        display flex\r\n        float right\r\n        margin 10px 0\r\n        .conversation-btn {\r\n            cursor pointer\r\n            padding 6px 12px\r\n            background #00A4FF\r\n            color #ffffff\r\n            font-size 14px\r\n            border-radius 20px\r\n            margin-left 13px\r\n        }\r\n    }\r\n    .message-wrapper {\r\n        margin: 5px 5px 10px 5px;\r\n        .content-wrapper {\r\n            display: flex\r\n            align-items: center\r\n            .message-container {\r\n                width 100%\r\n                .text-message {\r\n                    padding 3px 10px\r\n                }\r\n                .image-element {\r\n                    max-height 300px\r\n                }\r\n                .merger-item {\r\n                    border 1px solid #DEDEDE\r\n                    background-color #ffffff\r\n                    padding 0 10px\r\n                    border-radius 6px\r\n                    .merger-title {\r\n                        font-size 15px\r\n                        max-width 180px\r\n                        overflow hidden;\r\n                        text-overflow ellipsis;\r\n                        white-space nowrap;\r\n                    }\r\n                    .merger-text {\r\n                        color #B3B3B3\r\n                        margin 10px 0\r\n                        font-size 13px\r\n                        max-width 280px\r\n                        overflow hidden;\r\n                        text-overflow ellipsis;\r\n                        white-space nowrap;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    .group-layout, .c2c-layout, .system-layout {\r\n        display: flex;\r\n\r\n        .col-1 {\r\n            .avatar {\r\n                width: 56px;\r\n                height: 56px;\r\n                border-radius: 50%;\r\n                box-shadow: 0 5px 10px 0 rgba(0, 0, 0, 0.1);\r\n            }\r\n        }\r\n\r\n        .group-member-avatar {\r\n            cursor: pointer;\r\n        }\r\n\r\n        .col-2 {\r\n            display: flex;\r\n            flex-direction: column;\r\n            // max-width 50% // 此设置可以自适应宽度，目前由bubble限制\r\n        }\r\n\r\n        .col-3 {\r\n            width: 30px;\r\n        }\r\n\r\n        &.position-left {\r\n            .col-2 {\r\n                align-items: flex-start;\r\n            }\r\n        }\r\n\r\n        &.position-right {\r\n            flex-direction: row-reverse;\r\n\r\n            .col-2 {\r\n                align-items: flex-end;\r\n            }\r\n        }\r\n\r\n        &.position-center {\r\n            justify-content: center;\r\n        }\r\n    }\r\n\r\n    .c2c-layout {\r\n        .col-2 {\r\n            .base {\r\n                margin-top: 3px;\r\n            }\r\n        }\r\n    }\r\n\r\n    .group-layout {\r\n        .col-2 {\r\n            .chat-bubble {\r\n                margin-top: 5px;\r\n                outline none\r\n            }\r\n        }\r\n    }\r\n    .right {\r\n        display: flex;\r\n        flex-direction: row-reverse;\r\n    }\r\n\r\n    .left {\r\n        display: flex;\r\n        flex-direction: row;\r\n    }\r\n\r\n    .base {\r\n        color: $secondary;\r\n        font-size: 12px;\r\n    }\r\n\r\n    .name {\r\n        padding: 0 4px;\r\n        max-width: 100px;\r\n        overflow: hidden;\r\n        text-overflow: ellipsis;\r\n        white-space: nowrap;\r\n    }\r\n    .merger-video {\r\n        width 100%\r\n        max-height 300px\r\n    }\r\n    .file-box {\r\n        display: flex;\r\n    }\r\n    .file-icon {\r\n        font-size: 40px !important;\r\n    }\r\n    .file-element {\r\n        display: flex;\r\n        flex-direction: column;\r\n        margin-left: 12px;\r\n    }\r\n    .file-size {\r\n        font-size: 12px;\r\n        padding-top 5px\r\n    }\r\n\r\n    .text\r\n    font-weight bold\r\n    .title\r\n        font-size 16px\r\n        font-weight 600\r\n        padding-bottom 10px\r\n    .survey\r\n        background-color white\r\n        color black\r\n        padding 20px\r\n        display flex\r\n        flex-direction column\r\n    .suggestion\r\n        padding-top 10px\r\n        font-size 14px\r\n    .sound-element-wrapper {\r\n        background-color #fff\r\n        padding 2px 13px\r\n        cursor pointer\r\n        border-radius 3px\r\n    }\r\n</style>\r\n"]}]}