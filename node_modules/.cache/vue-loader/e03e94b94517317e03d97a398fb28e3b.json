{"remainingRequest":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\message\\merger-message\\message-relay.vue?vue&type=style&index=0&id=f8bdc7f0&lang=stylus&scoped=true&","dependencies":[{"path":"D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\message\\merger-message\\message-relay.vue","mtime":1649851412191},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\css-loader\\index.js","mtime":1649851454163},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1649851455885},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\postcss-loader\\src\\index.js","mtime":1649851455029},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\stylus-loader\\index.js","mtime":1649851453855},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js","mtime":1649851455309}],"contextDependencies":[],"result":["\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n.conversation-container {\n    position absolute\n    top 0\n    left 0\n    right 0\n    width 80%\n    margin auto\n    background-color #fff\n    z-index 999\n}\n.conversation-list-btn {\n    width 140px\n    display flex\n    float right\n    margin 10px 0\n    .conversation-btn {\n        cursor pointer\n        padding 6px 12px\n        background #00A4FF\n        color #ffffff\n        font-size 14px\n        border-radius 20px\n        margin-left 13px\n    }\n}\n",{"version":3,"sources":["message-relay.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"message-relay.vue","sourceRoot":"src/components/message/merger-message","sourcesContent":["<template>\r\n    <div class=\"chat-bubble\" @mousedown.stop @contextmenu.prevent>\r\n        <div class=\"conversation-container\">\r\n            <ConversationSelectedList   @getList=\"getList\"></ConversationSelectedList>\r\n            <div class=\"conversation-list-btn\">\r\n                <span class=\"conversation-btn\" @click=\"cancel\">取消</span>\r\n                <span class=\"conversation-btn\" @click=\"messageRelay\">发送</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n  import { mapState } from 'vuex'\r\n  import ConversationSelectedList from '../../conversation/conversation-selected-list'\r\n\r\n  export default {\r\n    name: 'MessageBubble',\r\n    components: {\r\n      ConversationSelectedList\r\n    },\r\n    data() {\r\n      return {\r\n        isTimeout: false,\r\n        showConversationList: false,\r\n        selectedConversation: [],\r\n        testMergerMessage: {}\r\n      }\r\n    },\r\n    created() {\r\n    },\r\n    mounted() {\r\n      if (this.$refs.dropdown && this.$refs.dropdown.$el) {\r\n        this.$refs.dropdown.$el.addEventListener('mousedown', this.handleDropDownMousedown)\r\n      }\r\n    },\r\n    beforeDestroy() {\r\n      if (this.$refs.dropdown && this.$refs.dropdown.$el) {\r\n        this.$refs.dropdown.$el.removeEventListener('mousedown', this.handleDropDownMousedown)\r\n      }\r\n    },\r\n    updated() {\r\n    },\r\n    computed: {\r\n      ...mapState({\r\n        isShowConversationList: state => state.conversation.isShowConversationList,\r\n        selectedMessageList: state => state.conversation.selectedMessageList,\r\n        relayType: state => state.conversation.relayType,\r\n        relayMessage: state => state.conversation.relayMessage\r\n      }),\r\n    },\r\n    methods: {\r\n      cancel() {\r\n        this.$store.commit('showConversationList', false)\r\n      },\r\n      getList(value) {\r\n        this.selectedConversation = value\r\n\r\n      },\r\n      sendSingleMessage(to, type, message) {\r\n        const _message = this.tim.createForwardMessage({\r\n          to: to,\r\n          conversationType: type,\r\n          payload: message,\r\n          priority: this.TIM.TYPES.MSG_PRIORITY_NORMAL\r\n        })\r\n        this.$store.commit('pushCurrentMessageList', _message)   // ??\r\n        return _message\r\n      },\r\n      mergerSort() {\r\n        this.selectedMessageList.sort((a, b) =>  {\r\n          if(a.time !== b.time) {\r\n            return a.time - b.time\r\n          }else {\r\n            return a.sequence - b.sequence\r\n          }\r\n        })\r\n      },\r\n      mergerMessage(to, type) {\r\n        let _abstractList = [], _count = 0, _title = ''\r\n        _count = this.selectedMessageList.length < 3 ? this.selectedMessageList.length : 3\r\n\r\n        for(let i = 0; i < _count; i++) {\r\n          _abstractList.push(this.setAbstractList(this.selectedMessageList[i]))\r\n        }\r\n        _title = this.selectedMessageList[0].conversationType === 'GROUP' ? '群聊的聊天记录' : `${this.selectedMessageList[0].nick || this.selectedMessageList[0].from} 和 ${this.selectedMessageList[0].to} 的聊天记录`\r\n        let message = this.tim.createMergerMessage({\r\n          to: to,\r\n          conversationType: type,\r\n          payload: {\r\n            messageList: this.selectedMessageList ,\r\n            title: _title,\r\n            abstractList: _abstractList,\r\n            compatibleText: '请升级IMSDK到v2.10.1或更高版本查看此消息'\r\n          }\r\n        })\r\n        this.$store.commit('pushCurrentMessageList', message)   // ??\r\n        return message\r\n      },\r\n      async messageRelay() {\r\n        let _type = '', _to = ''\r\n        for (let item of this.selectedConversation) {\r\n          if(item.indexOf(this.TIM.TYPES.CONV_C2C) !== -1) {\r\n            _type = this.TIM.TYPES.CONV_C2C\r\n            _to = item.substring(3, item.length)\r\n          }\r\n          if(item.indexOf(this.TIM.TYPES.CONV_GROUP) !== -1) {\r\n            _type = this.TIM.TYPES.CONV_GROUP\r\n            _to = item.substring(5, item.length)\r\n          }\r\n          // 排序\r\n          this.mergerSort()\r\n          if (this.relayType === 1) {\r\n            let message = this.sendSingleMessage(_to, _type, this.relayMessage)\r\n            this.sendMessageHandler(message)\r\n          }\r\n\r\n          if (this.relayType === 2) {\r\n            if(this.selectedMessageList.length > 30) {\r\n              this.$store.commit('showMessage', {\r\n                message: '转发消息仅支持30条以内',\r\n                type: 'error'\r\n              })\r\n              return\r\n            }\r\n            for (let selectedMessage of this.selectedMessageList) {\r\n              let message = await this.sendSingleMessage(_to, _type, selectedMessage)\r\n              await this.tim.sendMessage(message)\r\n                .then((res) => {\r\n                  return res\r\n                })\r\n                .catch(imError => {\r\n                  this.$store.commit('showMessage', {\r\n                    message: imError.message,\r\n                    type: 'error'\r\n                  })\r\n                })\r\n\r\n            }\r\n          }\r\n          if (this.relayType === 3) {\r\n            let message = this.mergerMessage(_to, _type)\r\n            this.sendMessageHandler(message)\r\n          }\r\n        }\r\n        this.$store.commit('showConversationList', false)\r\n        this.$store.commit('resetSelectedMessage', false)\r\n      },\r\n\r\n      sendMessageHandler(message) {\r\n        this.tim.sendMessage(message).catch(imError => {\r\n            this.$store.commit('showMessage', {\r\n              message: imError.message,\r\n              type: 'error'\r\n            })\r\n          })\r\n      },\r\n      setAbstractList(message) {\r\n        let nick = message.nick || message.from\r\n        let text = ''\r\n        switch (message.type) {\r\n          case this.TIM.TYPES.MSG_TEXT:\r\n            text = message.payload.text || ''\r\n            if (text.length > 20) {\r\n              text = text.slice(0, 20)\r\n            }\r\n            return `${nick}: ${text}`\r\n          case this.TIM.TYPES.MSG_MERGER:\r\n            return `${nick}: [聊天记录]`\r\n          case this.TIM.TYPES.MSG_IMAGE:\r\n            return `${nick}: [图片]`\r\n          case this.TIM.TYPES.MSG_AUDIO:\r\n            return `${nick}: [音频]`\r\n          case this.TIM.TYPES.MSG_VIDEO:\r\n            return `${nick}: [视频]`\r\n          case this.TIM.TYPES.MSG_CUSTOM:\r\n            return `${nick}: [自定义消息]`\r\n          case this.TIM.TYPES.MSG_FILE:\r\n            return `${nick}: [文件]`\r\n          case this.TIM.TYPES.MSG_FACE:\r\n            return `${nick}: [动画表情]`\r\n        }\r\n      },\r\n      handleDropDownMousedown(e) {\r\n        if (e.buttons === 2) {\r\n          if (this.$refs.dropdown.visible) {\r\n            this.$refs.dropdown.hide()\r\n          } else {\r\n            this.$refs.dropdown.show()\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n</script>\r\n\r\n<style lang=\"stylus\" scoped>\r\n    .conversation-container {\r\n        position absolute\r\n        top 0\r\n        left 0\r\n        right 0\r\n        width 80%\r\n        margin auto\r\n        background-color #fff\r\n        z-index 999\r\n    }\r\n    .conversation-list-btn {\r\n        width 140px\r\n        display flex\r\n        float right\r\n        margin 10px 0\r\n        .conversation-btn {\r\n            cursor pointer\r\n            padding 6px 12px\r\n            background #00A4FF\r\n            color #ffffff\r\n            font-size 14px\r\n            border-radius 20px\r\n            margin-left 13px\r\n        }\r\n    }\r\n</style>\r\n"]}]}