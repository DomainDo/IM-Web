{"remainingRequest":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\message\\merger-message\\message-relay.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\project\\softwareDevelopment\\IM-Web\\src\\components\\message\\merger-message\\message-relay.vue","mtime":1649851412191},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\babel-loader\\lib\\index.js","mtime":1649851455045},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1649851454799},{"path":"D:\\project\\softwareDevelopment\\IM-Web\\node_modules\\vue-loader\\lib\\index.js","mtime":1649851455309}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { mapState } from 'vuex'\nimport ConversationSelectedList from '../../conversation/conversation-selected-list'\n\nexport default {\n  name: 'MessageBubble',\n  components: {\n    ConversationSelectedList\n  },\n  data() {\n    return {\n      isTimeout: false,\n      showConversationList: false,\n      selectedConversation: [],\n      testMergerMessage: {}\n    }\n  },\n  created() {\n  },\n  mounted() {\n    if (this.$refs.dropdown && this.$refs.dropdown.$el) {\n      this.$refs.dropdown.$el.addEventListener('mousedown', this.handleDropDownMousedown)\n    }\n  },\n  beforeDestroy() {\n    if (this.$refs.dropdown && this.$refs.dropdown.$el) {\n      this.$refs.dropdown.$el.removeEventListener('mousedown', this.handleDropDownMousedown)\n    }\n  },\n  updated() {\n  },\n  computed: {\n    ...mapState({\n      isShowConversationList: state => state.conversation.isShowConversationList,\n      selectedMessageList: state => state.conversation.selectedMessageList,\n      relayType: state => state.conversation.relayType,\n      relayMessage: state => state.conversation.relayMessage\n    }),\n  },\n  methods: {\n    cancel() {\n      this.$store.commit('showConversationList', false)\n    },\n    getList(value) {\n      this.selectedConversation = value\n\n    },\n    sendSingleMessage(to, type, message) {\n      const _message = this.tim.createForwardMessage({\n        to: to,\n        conversationType: type,\n        payload: message,\n        priority: this.TIM.TYPES.MSG_PRIORITY_NORMAL\n      })\n      this.$store.commit('pushCurrentMessageList', _message)   // ??\n      return _message\n    },\n    mergerSort() {\n      this.selectedMessageList.sort((a, b) =>  {\n        if(a.time !== b.time) {\n          return a.time - b.time\n        }else {\n          return a.sequence - b.sequence\n        }\n      })\n    },\n    mergerMessage(to, type) {\n      let _abstractList = [], _count = 0, _title = ''\n      _count = this.selectedMessageList.length < 3 ? this.selectedMessageList.length : 3\n\n      for(let i = 0; i < _count; i++) {\n        _abstractList.push(this.setAbstractList(this.selectedMessageList[i]))\n      }\n      _title = this.selectedMessageList[0].conversationType === 'GROUP' ? '群聊的聊天记录' : `${this.selectedMessageList[0].nick || this.selectedMessageList[0].from} 和 ${this.selectedMessageList[0].to} 的聊天记录`\n      let message = this.tim.createMergerMessage({\n        to: to,\n        conversationType: type,\n        payload: {\n          messageList: this.selectedMessageList ,\n          title: _title,\n          abstractList: _abstractList,\n          compatibleText: '请升级IMSDK到v2.10.1或更高版本查看此消息'\n        }\n      })\n      this.$store.commit('pushCurrentMessageList', message)   // ??\n      return message\n    },\n    async messageRelay() {\n      let _type = '', _to = ''\n      for (let item of this.selectedConversation) {\n        if(item.indexOf(this.TIM.TYPES.CONV_C2C) !== -1) {\n          _type = this.TIM.TYPES.CONV_C2C\n          _to = item.substring(3, item.length)\n        }\n        if(item.indexOf(this.TIM.TYPES.CONV_GROUP) !== -1) {\n          _type = this.TIM.TYPES.CONV_GROUP\n          _to = item.substring(5, item.length)\n        }\n        // 排序\n        this.mergerSort()\n        if (this.relayType === 1) {\n          let message = this.sendSingleMessage(_to, _type, this.relayMessage)\n          this.sendMessageHandler(message)\n        }\n\n        if (this.relayType === 2) {\n          if(this.selectedMessageList.length > 30) {\n            this.$store.commit('showMessage', {\n              message: '转发消息仅支持30条以内',\n              type: 'error'\n            })\n            return\n          }\n          for (let selectedMessage of this.selectedMessageList) {\n            let message = await this.sendSingleMessage(_to, _type, selectedMessage)\n            await this.tim.sendMessage(message)\n              .then((res) => {\n                return res\n              })\n              .catch(imError => {\n                this.$store.commit('showMessage', {\n                  message: imError.message,\n                  type: 'error'\n                })\n              })\n\n          }\n        }\n        if (this.relayType === 3) {\n          let message = this.mergerMessage(_to, _type)\n          this.sendMessageHandler(message)\n        }\n      }\n      this.$store.commit('showConversationList', false)\n      this.$store.commit('resetSelectedMessage', false)\n    },\n\n    sendMessageHandler(message) {\n      this.tim.sendMessage(message).catch(imError => {\n          this.$store.commit('showMessage', {\n            message: imError.message,\n            type: 'error'\n          })\n        })\n    },\n    setAbstractList(message) {\n      let nick = message.nick || message.from\n      let text = ''\n      switch (message.type) {\n        case this.TIM.TYPES.MSG_TEXT:\n          text = message.payload.text || ''\n          if (text.length > 20) {\n            text = text.slice(0, 20)\n          }\n          return `${nick}: ${text}`\n        case this.TIM.TYPES.MSG_MERGER:\n          return `${nick}: [聊天记录]`\n        case this.TIM.TYPES.MSG_IMAGE:\n          return `${nick}: [图片]`\n        case this.TIM.TYPES.MSG_AUDIO:\n          return `${nick}: [音频]`\n        case this.TIM.TYPES.MSG_VIDEO:\n          return `${nick}: [视频]`\n        case this.TIM.TYPES.MSG_CUSTOM:\n          return `${nick}: [自定义消息]`\n        case this.TIM.TYPES.MSG_FILE:\n          return `${nick}: [文件]`\n        case this.TIM.TYPES.MSG_FACE:\n          return `${nick}: [动画表情]`\n      }\n    },\n    handleDropDownMousedown(e) {\n      if (e.buttons === 2) {\n        if (this.$refs.dropdown.visible) {\n          this.$refs.dropdown.hide()\n        } else {\n          this.$refs.dropdown.show()\n        }\n      }\n    }\n  }\n}\n",{"version":3,"sources":["message-relay.vue"],"names":[],"mappings":";;;;;;;;;;;;;AAaA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"message-relay.vue","sourceRoot":"src/components/message/merger-message","sourcesContent":["<template>\r\n    <div class=\"chat-bubble\" @mousedown.stop @contextmenu.prevent>\r\n        <div class=\"conversation-container\">\r\n            <ConversationSelectedList   @getList=\"getList\"></ConversationSelectedList>\r\n            <div class=\"conversation-list-btn\">\r\n                <span class=\"conversation-btn\" @click=\"cancel\">取消</span>\r\n                <span class=\"conversation-btn\" @click=\"messageRelay\">发送</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n  import { mapState } from 'vuex'\r\n  import ConversationSelectedList from '../../conversation/conversation-selected-list'\r\n\r\n  export default {\r\n    name: 'MessageBubble',\r\n    components: {\r\n      ConversationSelectedList\r\n    },\r\n    data() {\r\n      return {\r\n        isTimeout: false,\r\n        showConversationList: false,\r\n        selectedConversation: [],\r\n        testMergerMessage: {}\r\n      }\r\n    },\r\n    created() {\r\n    },\r\n    mounted() {\r\n      if (this.$refs.dropdown && this.$refs.dropdown.$el) {\r\n        this.$refs.dropdown.$el.addEventListener('mousedown', this.handleDropDownMousedown)\r\n      }\r\n    },\r\n    beforeDestroy() {\r\n      if (this.$refs.dropdown && this.$refs.dropdown.$el) {\r\n        this.$refs.dropdown.$el.removeEventListener('mousedown', this.handleDropDownMousedown)\r\n      }\r\n    },\r\n    updated() {\r\n    },\r\n    computed: {\r\n      ...mapState({\r\n        isShowConversationList: state => state.conversation.isShowConversationList,\r\n        selectedMessageList: state => state.conversation.selectedMessageList,\r\n        relayType: state => state.conversation.relayType,\r\n        relayMessage: state => state.conversation.relayMessage\r\n      }),\r\n    },\r\n    methods: {\r\n      cancel() {\r\n        this.$store.commit('showConversationList', false)\r\n      },\r\n      getList(value) {\r\n        this.selectedConversation = value\r\n\r\n      },\r\n      sendSingleMessage(to, type, message) {\r\n        const _message = this.tim.createForwardMessage({\r\n          to: to,\r\n          conversationType: type,\r\n          payload: message,\r\n          priority: this.TIM.TYPES.MSG_PRIORITY_NORMAL\r\n        })\r\n        this.$store.commit('pushCurrentMessageList', _message)   // ??\r\n        return _message\r\n      },\r\n      mergerSort() {\r\n        this.selectedMessageList.sort((a, b) =>  {\r\n          if(a.time !== b.time) {\r\n            return a.time - b.time\r\n          }else {\r\n            return a.sequence - b.sequence\r\n          }\r\n        })\r\n      },\r\n      mergerMessage(to, type) {\r\n        let _abstractList = [], _count = 0, _title = ''\r\n        _count = this.selectedMessageList.length < 3 ? this.selectedMessageList.length : 3\r\n\r\n        for(let i = 0; i < _count; i++) {\r\n          _abstractList.push(this.setAbstractList(this.selectedMessageList[i]))\r\n        }\r\n        _title = this.selectedMessageList[0].conversationType === 'GROUP' ? '群聊的聊天记录' : `${this.selectedMessageList[0].nick || this.selectedMessageList[0].from} 和 ${this.selectedMessageList[0].to} 的聊天记录`\r\n        let message = this.tim.createMergerMessage({\r\n          to: to,\r\n          conversationType: type,\r\n          payload: {\r\n            messageList: this.selectedMessageList ,\r\n            title: _title,\r\n            abstractList: _abstractList,\r\n            compatibleText: '请升级IMSDK到v2.10.1或更高版本查看此消息'\r\n          }\r\n        })\r\n        this.$store.commit('pushCurrentMessageList', message)   // ??\r\n        return message\r\n      },\r\n      async messageRelay() {\r\n        let _type = '', _to = ''\r\n        for (let item of this.selectedConversation) {\r\n          if(item.indexOf(this.TIM.TYPES.CONV_C2C) !== -1) {\r\n            _type = this.TIM.TYPES.CONV_C2C\r\n            _to = item.substring(3, item.length)\r\n          }\r\n          if(item.indexOf(this.TIM.TYPES.CONV_GROUP) !== -1) {\r\n            _type = this.TIM.TYPES.CONV_GROUP\r\n            _to = item.substring(5, item.length)\r\n          }\r\n          // 排序\r\n          this.mergerSort()\r\n          if (this.relayType === 1) {\r\n            let message = this.sendSingleMessage(_to, _type, this.relayMessage)\r\n            this.sendMessageHandler(message)\r\n          }\r\n\r\n          if (this.relayType === 2) {\r\n            if(this.selectedMessageList.length > 30) {\r\n              this.$store.commit('showMessage', {\r\n                message: '转发消息仅支持30条以内',\r\n                type: 'error'\r\n              })\r\n              return\r\n            }\r\n            for (let selectedMessage of this.selectedMessageList) {\r\n              let message = await this.sendSingleMessage(_to, _type, selectedMessage)\r\n              await this.tim.sendMessage(message)\r\n                .then((res) => {\r\n                  return res\r\n                })\r\n                .catch(imError => {\r\n                  this.$store.commit('showMessage', {\r\n                    message: imError.message,\r\n                    type: 'error'\r\n                  })\r\n                })\r\n\r\n            }\r\n          }\r\n          if (this.relayType === 3) {\r\n            let message = this.mergerMessage(_to, _type)\r\n            this.sendMessageHandler(message)\r\n          }\r\n        }\r\n        this.$store.commit('showConversationList', false)\r\n        this.$store.commit('resetSelectedMessage', false)\r\n      },\r\n\r\n      sendMessageHandler(message) {\r\n        this.tim.sendMessage(message).catch(imError => {\r\n            this.$store.commit('showMessage', {\r\n              message: imError.message,\r\n              type: 'error'\r\n            })\r\n          })\r\n      },\r\n      setAbstractList(message) {\r\n        let nick = message.nick || message.from\r\n        let text = ''\r\n        switch (message.type) {\r\n          case this.TIM.TYPES.MSG_TEXT:\r\n            text = message.payload.text || ''\r\n            if (text.length > 20) {\r\n              text = text.slice(0, 20)\r\n            }\r\n            return `${nick}: ${text}`\r\n          case this.TIM.TYPES.MSG_MERGER:\r\n            return `${nick}: [聊天记录]`\r\n          case this.TIM.TYPES.MSG_IMAGE:\r\n            return `${nick}: [图片]`\r\n          case this.TIM.TYPES.MSG_AUDIO:\r\n            return `${nick}: [音频]`\r\n          case this.TIM.TYPES.MSG_VIDEO:\r\n            return `${nick}: [视频]`\r\n          case this.TIM.TYPES.MSG_CUSTOM:\r\n            return `${nick}: [自定义消息]`\r\n          case this.TIM.TYPES.MSG_FILE:\r\n            return `${nick}: [文件]`\r\n          case this.TIM.TYPES.MSG_FACE:\r\n            return `${nick}: [动画表情]`\r\n        }\r\n      },\r\n      handleDropDownMousedown(e) {\r\n        if (e.buttons === 2) {\r\n          if (this.$refs.dropdown.visible) {\r\n            this.$refs.dropdown.hide()\r\n          } else {\r\n            this.$refs.dropdown.show()\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n</script>\r\n\r\n<style lang=\"stylus\" scoped>\r\n    .conversation-container {\r\n        position absolute\r\n        top 0\r\n        left 0\r\n        right 0\r\n        width 80%\r\n        margin auto\r\n        background-color #fff\r\n        z-index 999\r\n    }\r\n    .conversation-list-btn {\r\n        width 140px\r\n        display flex\r\n        float right\r\n        margin 10px 0\r\n        .conversation-btn {\r\n            cursor pointer\r\n            padding 6px 12px\r\n            background #00A4FF\r\n            color #ffffff\r\n            font-size 14px\r\n            border-radius 20px\r\n            margin-left 13px\r\n        }\r\n    }\r\n</style>\r\n"]}]}